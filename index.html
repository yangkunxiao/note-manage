<!DOCTYPE html>


<html lang="zh-CN" >


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="javascript typescript php node html html5 css linux vue react 算法 数据结构" />
   
  <meta name="description" content="前端工程师" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Walter
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/logo.png" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

<link rel="alternate" href="/atom.xml" title="Walter" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

</html>

<body>
  <div id="app">
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/yangkunxiao"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Walter</a></h1>
      <div id="subtitle-box">
        
          <span id="subtitle">面朝大海 春暖花开</span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" target="_blank" rel="noopener" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-Webpack/08" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/04/06/Webpack/08/"
    >webpack性能优化</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/04/06/Webpack/08/" class="article-date">
  <time datetime="2020-04-06T10:00:00.000Z" itemprop="datePublished">2020-04-06</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/webpack/">webpack</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="webpack性能优化"><a href="#webpack性能优化" class="headerlink" title="webpack性能优化"></a>webpack性能优化</h1><ol>
<li>使用<code>DllPlugin</code>和<code>DLLReferencePlugin</code>：<ol>
<li><code>DLLPlugin</code> 和 <code>DLLReferencePlugin</code> 用某种方法实现了拆分 <code>bundles</code>，同时还大大提升了构建的速度。</li>
</ol>
</li>
</ol>
<p>包含大量复用模块的动态链接库只需被编译一次，在之后的构建过程中被动态链接库包含的模块将不会重新编译，而是直接使用动态链接库中 的代码 由于动态链接库中大多数包含的是常用的第三方模块。例如 <code>vue、vue-router</code> ，所以只要不升级这些模块的版本，动态链接库就不用重新编译。</p>
<h3 id="使用更高版本的webpack和node"><a href="#使用更高版本的webpack和node" class="headerlink" title="使用更高版本的webpack和node"></a>使用更高版本的webpack和node</h3><h3 id="优化Loader配置"><a href="#优化Loader配置" class="headerlink" title="优化Loader配置"></a>优化Loader配置</h3><p>由于 <code>Loader</code> 对文件的转换操作很耗时，所以需要让尽可能少的文件被 <code>Loader</code> 处理。可以通过 <code>test</code> <code>include</code> <code>exclude</code> 三个配置项来命中 <code>Loader</code> 要应用规则的文件。</p>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> 
  module <span class="token punctuation">:</span> <span class="token punctuation">{</span> 
    rules <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//如果项目源码中只有js文件，就不要写成/\jsx?$/，以提升正则表达式的性能</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span> 
      <span class="token comment" spellcheck="true">//babel -loader 支持缓存转换出的结果，通过 cacheDirectory 选项开启</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader?cacheDirectory'</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> 
      <span class="token comment" spellcheck="true">//只对项目根目录下 src 目录中的文件采用 babel-loader</span>
      include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="优化-resolve-extensions-配置"><a href="#优化-resolve-extensions-配置" class="headerlink" title="优化 resolve.extensions 配置"></a>优化 resolve.extensions 配置</h3><p>在导入语句没带文件后缀时，Webpack 会自动带上后缀去尝试询问文件是否存在。如果这个列表越长，或者正确的后缀越往后，就会造成尝试的次数越多，所以resolve .extensions 的配置也会影响到构建的性能。<br>建议：</p>
<ul>
<li>后缀尝试列表要尽可能小，不要将项目中不可能存在的情况写到后缀尝试列表中。</li>
<li>频率出现最高的文件后缀要优先放在最前面，以做到尽快退出寻找过程。</li>
<li>在源码中写导入语句时，要尽可能带上后缀 从而可以避免寻找过程</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> 
  resolve <span class="token punctuation">:</span> <span class="token punctuation">{</span> 
    <span class="token comment" spellcheck="true">//尽可能减少后缀尝试的可能性</span>
    extensions <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="静态资源优化"><a href="#静态资源优化" class="headerlink" title="静态资源优化"></a>静态资源优化</h3><h4 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h4><p>使用<code>DllPlugin</code>和<code>DLLReferencePlugin</code>，拆分<code>bundles</code>。具体使用请看<a href="https://www.yuque.com/walter-glskq/zf7grn/mgw9o4" target="_blank" rel="noopener">这一篇文章</a>。也可以使用<a href="https://www.npmjs.com/package/hard-source-webpack-plugin" target="_blank" rel="noopener">hard-source-webpack-plugin</a>替换<code>DllPlugin</code>和<code>DLLReferencePlugin</code>。<br>生产环境webpack默认开启<code>uglify-js</code>。</p>
<h5 id="压缩js"><a href="#压缩js" class="headerlink" title="压缩js"></a>压缩js</h5><pre class=" language-javascript"><code class="language-javascript">optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    minimizer<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        uglifyOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          mangle<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            safari10<span class="token punctuation">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment" spellcheck="true">// 清除生产环境的控制台输出</span>
          compress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            drop_debugger<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        sourceMap<span class="token punctuation">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>productionSourceMap<span class="token punctuation">,</span>
        cache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        parallel<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span></code></pre>
<h5 id="抽离公共js文件"><a href="#抽离公共js文件" class="headerlink" title="抽离公共js文件"></a>抽离公共js文件</h5><pre class=" language-javascript"><code class="language-javascript">splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    chunks<span class="token punctuation">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//进行代码分割的时候，all：针对所有的导入  async:只针对异步导入 initial:针对同步代码导入。</span>
    minSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//设置最小阀值，只有大于该阀值，才会进行代码分割。</span>
    minChunks<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//在分割模块之前共享一个模块的最小块数（设置代码最少被引用次数）</span>
    maxAsyncRequests<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//按需加载时的最大并行请求数 超过就不会在做代码分割打包</span>
    maxInitialRequests<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//一个入口点的最大并行请求数  超过就不会做代码分割</span>
    automaticNameDelimiter<span class="token punctuation">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//打包生成之后，默认情况下，webpack将使用块的来源和名称来生成名称，比如vendor~main.js。</span>
    name<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//使得cacheGroups中打包生成的文件名称</span>
    cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//缓存组 打包分组</span>
      vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//配置同步导入 </span>
        test<span class="token punctuation">:</span> <span class="token regex">/[\\/]node_modules[\\/]/</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//只有node_module中的才会进入</span>
        priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//值越大 优先级越高</span>
        filename<span class="token punctuation">:</span> <span class="token string">'vendors.js'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// minChunks: 2,</span>
        priority<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 如果模块已经被打包了，在此遇到的时候 直接忽略，直接使用以打包好的模块。</span>
        filename<span class="token punctuation">:</span><span class="token string">'default.js'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<h5 id="关于代码分离"><a href="#关于代码分离" class="headerlink" title="关于代码分离"></a>关于代码分离</h5><p>请移步<a href="https://www.yuque.com/walter-glskq/zf7grn/zcamxf" target="_blank" rel="noopener">https://www.yuque.com/walter-glskq/zf7grn/zcamxf</a></p>
<h4 id="css"><a href="#css" class="headerlink" title="css"></a>css</h4><p><code>extract-text-webpack-plugin</code>和<code>mini-css-extract-plugin</code>使用该插件将css文件从js中剥离出来，进行优化压缩。配合<code>postcss-loader</code>进行css预处理和后处理。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//压缩css 并且将css从js抽离出来</span>
<span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//优化css</span>
<span class="token keyword">const</span> OptimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
             test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
       use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
         loader<span class="token punctuation">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
         options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
           esModule<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           filename<span class="token punctuation">:</span> <span class="token string">'/css/[name].[hash:7].css'</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span><span class="token string">'less-loader'</span><span class="token punctuation">]</span>
   <span class="token punctuation">}</span><span class="token punctuation">]</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      filename<span class="token punctuation">:</span> <span class="token string">'css/[name].[hash:5].css'</span><span class="token punctuation">,</span>
      chunkFilename<span class="token punctuation">:</span> <span class="token string">'css/[id].[hash:5].css'</span><span class="token punctuation">,</span>
      ignoreOrder<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">OptimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      assetNameRegExp<span class="token punctuation">:</span> <span class="token regex">/\.css$/g</span><span class="token punctuation">,</span>
      cssProcessor<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cssnano'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      cssProcessorPluginOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        preset<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> discardComments<span class="token punctuation">:</span> <span class="token punctuation">{</span> removeAll<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      canPrint<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="img"><a href="#img" class="headerlink" title="img"></a>img</h4><p>使用<code>file-loader和image-webpack-loader</code>处理图片文件，进行压缩。</p>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/.*\.(gif|png|jpe?g|svg|webp)$/i</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">'image-webpack-loader'</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              mozjpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 压缩 jpeg 的配置</span>
                progressive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                quality<span class="token punctuation">:</span> <span class="token number">65</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              optipng<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 使用 imagemin-optipng 压缩 png，enable: false 为关闭</span>
                enabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              pngquant<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 使用 imagemin-pngquant 压缩 png</span>
                quality<span class="token punctuation">:</span> <span class="token string">'65-90'</span><span class="token punctuation">,</span>
                speed<span class="token punctuation">:</span> <span class="token number">4</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              gifsicle<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 压缩 gif 的配置</span>
                interlaced<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              webp<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 开启 webp，会把 jpg 和 png 图片压缩为 webp 格式</span>
                quality<span class="token punctuation">:</span> <span class="token number">75</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>
<p>使用url-loader将一些小图片转为base64格式，减少http请求：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|jpeg|gif)(\?.+)?$/</span><span class="token punctuation">,</span>
        exclude<span class="token punctuation">:</span> <span class="token regex">/favicon\.png$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//动态抽离img 给一个阀值 小于该阀值的 以base64的形式存在与js中</span>
          esModule<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          limit<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">'image/[name].[hash:7].[ext]'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="优化HTML模板"><a href="#优化HTML模板" class="headerlink" title="优化HTML模板"></a>优化HTML模板</h3><p>配置minify，优化html文件。生产环境生效。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
  template<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
  inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  title<span class="token punctuation">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
  minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 合并空格</span>
    collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 移除注解</span>
    removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 移除多余的属性</span>
    removeRedundantAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 移除脚本类型属性</span>
    removeScriptTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 移除样式类型属性</span>
    removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 使用简短的文档类型</span>
    useShortDoctype<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token comment" spellcheck="true">// more options:</span>
    <span class="token comment" spellcheck="true">// https://github.com/kangax/html-minifier#options-quick-reference</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre>
<h4 id="优化打包加速"><a href="#优化打包加速" class="headerlink" title="优化打包加速"></a>优化打包加速</h4><p>使用<code>webpack-parallel-uglify-plugin</code>。webpack默认提供了UglifyJS插件来压缩JS代码，但是它使用的是单线程压缩代码，也就是说多个js文件需要被压缩，它需要一个个文件进行压缩。所以说在正式环境打包压缩代码速度非常慢(因为压缩JS代码需要先把代码解析成用Object抽象表示的AST语法树，再去应用各种规则分析和处理AST，导致这个过程耗时非常大)。当webpack有多个JS文件需要输出和压缩时候，原来会使用UglifyJS去一个个压缩并且输出，但是ParallelUglifyPlugin插件则会开启多个子进程，把对多个文件压缩的工作分别给多个子进程去完成，但是每个子进程还是通过UglifyJS去压缩代码。无非就是变成了并行处理该压缩了，并行处理多个子任务，效率会更加的提高。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 引入 ParallelUglifyPlugin 插件</span>
<span class="token keyword">const</span> ParallelUglifyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 使用 ParallelUglifyPlugin 并行压缩输出JS代码</span>
    <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 传递给 UglifyJS的参数如下：</span>
      uglifyJS<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">/*
           是否输出可读性较强的代码，即会保留空格和制表符，默认为输出，为了达到更好的压缩效果，
           可以设置为false
          */</span>
          beautify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token comment" spellcheck="true">/*
           是否保留代码中的注释，默认为保留，为了达到更好的压缩效果，可以设置为false
          */</span>
          comments<span class="token punctuation">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        compress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">/*
           是否在UglifyJS删除没有用到的代码时输出警告信息，默认为输出，可以设置为false关闭这些作用
           不大的警告
          */</span>
          warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

          <span class="token comment" spellcheck="true">/*
           是否删除代码中所有的console语句，默认为不删除，开启后，会删除所有的console语句
          */</span>
          drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

          <span class="token comment" spellcheck="true">/*
           是否内嵌虽然已经定义了，但是只用到一次的变量，比如将 var x = 1; y = x, 转换成 y = 1, 默认为不
           转换，为了达到更好的压缩效果，可以设置为false
          */</span>
          collapse_vars<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

          <span class="token comment" spellcheck="true">/*
           是否提取出现了多次但是没有定义成变量去引用的静态值，比如将 x = 'xxx'; y = 'xxx'  转换成
           var a = 'xxxx'; x = a; y = a; 默认为不转换，为了达到更好的压缩效果，可以设置为false
          */</span>
          reduce_vars<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<pre><code>在通过 new ParallelUglifyPlugin() 实列化时，支持以下参数配置如下：

test: 使用正则去匹配哪些文件需要被 ParallelUglifyPlugin 压缩，默认是 /.js$/.
include: 使用正则去包含被 ParallelUglifyPlugin 压缩的文件，默认为 [].
exclude: 使用正则去不包含被 ParallelUglifyPlugin 压缩的文件，默认为 [].
cacheDir: 缓存压缩后的结果，下次遇到一样的输入时直接从缓存中获取压缩后的结果并返回，cacheDir 用于配置缓存存放的目录路径。默认不会缓存，想开启缓存请设置一个目录路径。

workerCount：开启几个子进程去并发的执行压缩。默认是当前运行电脑的 CPU 核数减去1。
sourceMap：是否为压缩后的代码生成对应的Source Map, 默认不生成，开启后耗时会大大增加，一般不会将压缩后的代码的
sourceMap发送给网站用户的浏览器。
uglifyJS：用于压缩 ES5 代码时的配置，Object 类型，直接透传给 UglifyJS 的参数。</code></pre><h3 id="优化小插件"><a href="#优化小插件" class="headerlink" title="优化小插件"></a>优化小插件</h3><h4 id="speed-measure-webpack-plugin"><a href="#speed-measure-webpack-plugin" class="headerlink" title="speed-measure-webpack-plugin"></a>speed-measure-webpack-plugin</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//添加打包时各种资源构建小时钟提示 有助于分析</span>
<span class="token keyword">const</span> SpeedMeasurePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"speed-measure-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasurePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="webpack-bundle-analyzer"><a href="#webpack-bundle-analyzer" class="headerlink" title="webpack-bundle-analyzer"></a>webpack-bundle-analyzer</h4><p>打包分析工具</p>
<pre class=" language-javascript"><code class="language-javascript">npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev webpack<span class="token operator">-</span>bundle<span class="token operator">-</span>analyzer

在webpack的plugins中配置： <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

在<span class="token keyword">package</span><span class="token punctuation">.</span>json 中增加： <span class="token string">"analyz"</span><span class="token punctuation">:</span> <span class="token string">"NODE_ENV=production npm_config_report=true npm run build"</span></code></pre>
<h4 id="webpack-dashboard"><a href="#webpack-dashboard" class="headerlink" title="webpack-dashboard"></a>webpack-dashboard</h4><p>更加直观的显示webpack的构建。</p>
<pre class=" language-javascript"><code class="language-javascript">npm install webpack<span class="token operator">-</span>dashboard <span class="token operator">--</span>save<span class="token operator">-</span>dev

<span class="token keyword">const</span> Dashboard <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dashboard'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> DashboardPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dashboard/plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dashboard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">DashboardPlugin</span><span class="token punctuation">(</span>dashboard<span class="token punctuation">.</span>setData<span class="token punctuation">)</span>
<span class="token punctuation">]</span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585733343507-1b89d2eb-a890-49cb-a982-ac6ee452877b.png#align=left&display=inline&height=350&name=image.png&originHeight=700&originWidth=1200&size=375613&status=done&style=none&width=600" alt="image.png"></p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Interview/07" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/28/Interview/07/"
    >Flex布局</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/28/Interview/07/" class="article-date">
  <time datetime="2020-03-28T14:20:00.000Z" itemprop="datePublished">2020-03-28</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/CSS/">CSS</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="Flex布局"><a href="#Flex布局" class="headerlink" title="Flex布局"></a>Flex布局</h1><h3 id="flex布局"><a href="#flex布局" class="headerlink" title="flex布局"></a>flex布局</h3><p>flex是flexible box的缩写，意为“弹性盒子”，用来给盒模型提供最大的灵活性。<br>任何一个容器都可以指定为felx布局。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">{</span>
    display<span class="token punctuation">:</span>flex<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/*webkit内核*/</span>
  display<span class="token punctuation">:</span><span class="token operator">-</span>webkit<span class="token operator">-</span>flex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/*行内元素*/</span>
<span class="token punctuation">.</span>inline<span class="token punctuation">{</span>
    display<span class="token punctuation">:</span>inline<span class="token operator">-</span>flex<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>注意，设为 Flex 布局以后，子元素的<code>float</code>、<code>clear</code>和<code>vertical-align</code>属性将失效</p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>采用flex布局的元素，称为flex容器，容器内的每一个元素自动成容器成员，称为flex 项目，简称“项目”。<br>容器默认存在两根轴：水平的主轴（main axis）和 垂直的交叉轴（cross axis）。主轴的开始位置（与边框的交叉点）叫做main start，结束位置叫做main end；交叉轴的开始位置叫做cross start，结束位置叫做cross end。</p>
<p>项目默认沿主轴排列。单个项目占据的主轴空间叫做main size，占据的交叉轴空间叫做cross size。</p>
<h3 id="容器属性"><a href="#容器属性" class="headerlink" title="容器属性"></a>容器属性</h3><p>以下属性设置在容器上。</p>
<pre><code>flex-direction
flex-wrap
flex-flow
justify-content
align-items
align-content</code></pre><h4 id="flex-direction"><a href="#flex-direction" class="headerlink" title="flex-direction"></a>flex-direction</h4><p>该属性决定主轴的方向，即项目的排列方向。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box <span class="token punctuation">{</span>
  flex<span class="token operator">-</span>direction<span class="token punctuation">:</span> row <span class="token operator">|</span> row<span class="token operator">-</span>reverse <span class="token operator">|</span> column <span class="token operator">|</span> column<span class="token operator">-</span>reverse<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>属性值有四个：</p>
<pre><code>row（默认值）：主轴为水平方向，起点在左端。
row-reverse：主轴为水平方向，起点在右端。
column：主轴为垂直方向，起点在上沿。
column-reverse：主轴为垂直方向，起点在下沿。</code></pre><h4 id="flex-wrap"><a href="#flex-wrap" class="headerlink" title="flex-wrap"></a>flex-wrap</h4><p>默认情况下，项目都排在一条线（又称”轴线”）上。flex-wrap属性定义，如果一条轴线排不下，如何换行。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">{</span>
  flex<span class="token operator">-</span>wrap<span class="token punctuation">:</span> nowrap <span class="token operator">|</span> wrap <span class="token operator">|</span> wrap<span class="token operator">-</span>reverse<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>有三个取值：</p>
<pre><code>nowrap: 默认。不换行。
wrap：换行，第一行在上方。
wrap-reverse：换行，第一行在下方。</code></pre><h4 id="flex-flow"><a href="#flex-flow" class="headerlink" title="flex-flow"></a>flex-flow</h4><p>flex-flow属性是flex-direction属性和flex-wrap属性的简写形式，默认值为row nowrap。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box <span class="token punctuation">{</span>
  flex<span class="token operator">-</span>flow<span class="token punctuation">:</span> <span class="token operator">&lt;</span>flex<span class="token operator">-</span>direction<span class="token operator">></span> <span class="token operator">||</span> <span class="token operator">&lt;</span>flex<span class="token operator">-</span>wrap<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="justify-content"><a href="#justify-content" class="headerlink" title="justify-content"></a>justify-content</h4><p>该属性定义了项目在主轴上的对其方式。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box <span class="token punctuation">{</span>
  justify<span class="token operator">-</span>content<span class="token punctuation">:</span> flex<span class="token operator">-</span>start <span class="token operator">|</span> flex<span class="token operator">-</span>end <span class="token operator">|</span> center <span class="token operator">|</span> space<span class="token operator">-</span>between <span class="token operator">|</span> space<span class="token operator">-</span>around<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>该属性有五个取值：</p>
<pre><code>flex-start（默认值）：左对齐
flex-end：右对齐
center： 居中
space-between：两端对齐，项目之间的间隔都相等。
space-around：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍。</code></pre><h4 id="align-items"><a href="#align-items" class="headerlink" title="align-items"></a>align-items</h4><p>该属性定义了项目在交叉轴如何对齐。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">{</span>
    align<span class="token operator">-</span>items<span class="token punctuation">:</span>flex<span class="token operator">-</span>start <span class="token operator">|</span> flex<span class="token operator">-</span>end <span class="token operator">|</span> center <span class="token operator">|</span> baseline <span class="token operator">|</span> stretch
<span class="token punctuation">}</span></code></pre>
<p>该属性有五个取值：</p>
<pre><code>flex-start: 交叉轴起点对齐。
flesx-end：交叉轴终点对齐。
center：交叉轴中点对齐。
baseline：项目的第一行文字的基线对齐。
stretch：如果项目未设置高度或者设置为auto，将占满整个容器的高度。</code></pre><h4 id="align-content"><a href="#align-content" class="headerlink" title="align-content"></a>align-content</h4><p>该属性定义了多根轴线的对齐方式。如果该项目只有一根轴线，则不起作用。</p>
<pre><code>.box{
    align-content: felx-start | flex-end | center | space-between | space-around | stretch
}</code></pre><pre><code>flex-start：与交叉轴的起点对齐。
flex-end：与交叉轴的终点对齐。
center：与交叉轴的中点对齐。
space-between：与交叉轴两端对齐，轴线之间的间隔平均分布。
space-around：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。
stretch（默认值）：轴线占满整个交叉轴。</code></pre><h3 id="项目属性"><a href="#项目属性" class="headerlink" title="项目属性"></a>项目属性</h3><p>以下属性定义在项目上：</p>
<pre><code>order
flex-grow
flex-shrink
flex-basis
flex
align-self</code></pre><h4 id="order"><a href="#order" class="headerlink" title="order"></a>order</h4><p>该属性定义项目的排列顺序。数值越小，排列越靠前，默认为0.</p>
<pre><code>.item{
    order:&lt;integer&gt;
}</code></pre><h4 id="flex-grow"><a href="#flex-grow" class="headerlink" title="flex-grow"></a>flex-grow</h4><p>该属性定义了项目的放大比例，默认为0，即如果存在剩余空间，也不放大。</p>
<pre><code>.item{
    flex-grow:&lt;number&gt;
}</code></pre><h4 id="flex-shrink"><a href="#flex-shrink" class="headerlink" title="flex-shrink"></a>flex-shrink</h4><p>该属性定义了项目的缩小比例，默认为1，即如果空间不足，则缩小。</p>
<pre><code>.item{
    flex-shrink:&lt;number&gt;
}</code></pre><p>当所有的项目的<code>flex-shrink</code>的值都为1，则当项空间不足时，等比例缩小。如果一个项目的<code>flex-shrink</code>值为0，其他项目为1，则空间不足时，前者不缩小。</p>
<h4 id="flex-basis"><a href="#flex-basis" class="headerlink" title="flex-basis"></a>flex-basis</h4><p>该属性定义了在分配剩余空间之前，项目占据的主轴空间，浏览器将根据该属性计算主轴是否有多余空间。默认为auto，即项目本来大小。</p>
<pre><code>.item{
    flex-basis:&lt;length&gt; | auto
}</code></pre><h4 id="flex"><a href="#flex" class="headerlink" title="flex"></a>flex</h4><p>该属性是flex-grow、flex-shrink和flex-basis的简写。<code>默认值为 0 1 auto</code>，后两个属性可选</p>
<pre><code>.item{
    flex: none | &lt;flex-grow&gt; &lt;flex-shrink&gt; &lt;flex-basis&gt; 
}</code></pre><p>该属性有两个快捷键：auto（1 1 auto） 和 none （0 0 auto）</p>
<h4 id="align-self"><a href="#align-self" class="headerlink" title="align-self"></a>align-self</h4><p>align-self属性允许单个项目有与其他项目不一样的对齐方式，可覆盖align-items属性。默认值为auto，表示继承父元素的align-items属性，如果没有父元素，则等同于stretch</p>
<pre><code>.item {
  align-self: auto | flex-start | flex-end | center | baseline | stretch;
}</code></pre><p>该属性可能取6个值，除了auto，其他都与align-items属性完全一致。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS-Flex/" rel="tag">CSS Flex</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Vue/源码解读/变化侦测相关API的实现原理" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/26/Vue/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E5%8F%98%E5%8C%96%E4%BE%A6%E6%B5%8B%E7%9B%B8%E5%85%B3API%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"
    >vue源码解读(二)：变化侦测相关API的实现原理</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/26/Vue/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E5%8F%98%E5%8C%96%E4%BE%A6%E6%B5%8B%E7%9B%B8%E5%85%B3API%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="article-date">
  <time datetime="2020-03-26T14:30:00.000Z" itemprop="datePublished">2020-03-26</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="vue源码解读-二-：变化侦测相关API的实现原理"><a href="#vue源码解读-二-：变化侦测相关API的实现原理" class="headerlink" title="vue源码解读(二)：变化侦测相关API的实现原理"></a>vue源码解读(二)：变化侦测相关API的实现原理</h1><h3 id="vm-watch"><a href="#vm-watch" class="headerlink" title="vm.$watch"></a>vm.$watch</h3><h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p><code>vm.$watch(expOrFn,callback,options)</code><br>参数：</p>
<ul>
<li>{ string | Function } expOrFn</li>
<li>{ Function | Object  } callback</li>
<li>{ Object } options</li>
</ul>
<p>返回值：{ Function } unwatch<br>用法：用于观察一个表达式或者computed函数在vue实例上的变化。回调函数调用时，会从参数中回去新数据和老数据。表达式直接受以.为分隔符的路径。<br>例如：</p>
<pre class=" language-javascript"><code class="language-javascript">vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'a.b.c'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span>oldVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p><code>vm.$watch</code>返回一个取消观察函数<code>unwatch</code>，用于停止触发回调。<br>参数<code>options</code>：</p>
<ul>
<li><code>deep</code>：为了可以发现对象内部的属性变化，可以添加<code>deep:true</code>进行深度监听。</li>
<li><code>immediate</code>：在参数中指定<code>immediate：true</code>，将立即以表达式的当前值触发回调函数。</li>
</ul>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><code>vm.$watch</code>其实内部也是对<code>Watcher</code>的封装。我们来看一下vue内部是如何实现<code>deep</code>和<code>immediate</code>的。</p>
<blockquote>
<p>src/core/instance/state.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$watch <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    cb<span class="token punctuation">:</span> any<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token punctuation">:</span> Object
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`callback for immediate watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> unwatchFn <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>在这段代码中，可以看出，在初始化组件的时候，如果用户使用了<code>immddiate</code>参数，那么就会立即执行一次cb，返回一个新的函数unwatchFn()，在返回函数中调用了watcher的teardown()方法，我们来看一下该方法做了什么：</p>
<blockquote>
<p>src/core/observer/watcher.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/**
   * Remove self from all dependencies' subscriber list.
   */</span>
  teardown <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// remove self from vm's watcher list</span>
      <span class="token comment" spellcheck="true">// this is a somewhat expensive operation so we skip it</span>
      <span class="token comment" spellcheck="true">// if the vm is being destroyed.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>当执行该方法后，就会将<code>Watcher</code>实例从当前观察的依赖列表中移除。<br>因此，当前我们需要在<code>Watcher</code>中记录自己都订阅了谁，也就是<code>Watcher</code>实例都被收集进哪些<code>Dep</code>中了。然后当<code>Watcher</code>不想继续订阅这些依赖时，循环遍历这些记录，通知<code>Dep</code>，将自己从它们的依赖列表中移除。<br>现在<code>Watcher</code>中添加<code>addDep</code>方法，该方法的作用是让<code>Watcher</code>记录自己订阅过哪些<code>Dep</code></p>
<blockquote>
<p>src/core/observer/watcher.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment" spellcheck="true">/**
   * Add a dependency to this directive.
   */</span>
addDep <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p> 在上述代码中，通过<code>depIds</code>来判断当前<code>Watcher</code>是否订阅过该<code>Dep</code>，就可以避免重复订阅。<br>执行<code>this.newDepIds.add(id)</code>来记录当前<code>Watcher</code>一定订阅来该<code>Dep</code>。<br>执行<code>this.newDeps.push(dep)</code>来记录自己订阅了哪些<code>Dep</code>。<br>执行<code>dep.addSub(this)</code>来将自己订阅到<code>Dep</code>中。<br>现在我们已经知道了vue.$watcher是如何记录Dep的，上面也提到过它是通过循环遍历依赖列表，使用<code>this.deps[i].removeSub(this)</code>来移除依赖的，接下来我们来看看<code>removeSub</code>是如何实现移除依赖列表的：</p>
<blockquote>
<p>src/core/observer/dep.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript">removeSub <span class="token punctuation">(</span>sub<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/**
 * Remove an item from an array.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> remove <span class="token punctuation">(</span>arr<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>其实就是使用数组的<code>splice</code>方法将其删除，然后当数据发生变化后，将不再通知该<code>Watcher</code>。</p>
<h4 id="deep的原理"><a href="#deep的原理" class="headerlink" title="deep的原理"></a>deep的原理</h4><p>在之前的一篇<a href="https://www.yuque.com/walter-glskq/zf7grn/lys7df" target="_blank" rel="noopener">文章</a>中讲过，<code>Vue</code>中的依赖收集和依赖触发。当<code>Watcher</code>想监听某个数据的时候，就会触发该数据的依赖收集逻辑，将自己收集进去，当数据发生变化的时候，通知<code>Watcher</code>。而实现deep功能，除了将当前数据进行依赖收集之外，还有递归的将其子数据也进行依赖收集，这样当子数据发生变化的时候，就会通知当前Watcher了。<br>具体实现：</p>
<blockquote>
<p>src/core/observer/watcher.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>src/core/observer/traverse.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/* @flow */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> _Set <span class="token keyword">as</span> Set<span class="token punctuation">,</span> isObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span> SimpleSet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token keyword">import</span> VNode <span class="token keyword">from</span> <span class="token string">'../vdom/vnode'</span>

<span class="token keyword">const</span> seenObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/**
 * Recursively traverse an object to evoke all converted
 * getters, so that every nested property inside the object
 * is collected as a "deep" dependency.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> traverse <span class="token punctuation">(</span>val<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_traverse</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> seenObjects<span class="token punctuation">)</span>
  seenObjects<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> _traverse <span class="token punctuation">(</span>val<span class="token punctuation">:</span> any<span class="token punctuation">,</span> seen<span class="token punctuation">:</span> SimpleSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token punctuation">,</span> keys
  <span class="token keyword">const</span> isA <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">//如果当前数据不是数组、对象、或者被冻结、或者是VNode，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>isA <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">||</span> val <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//数据已经是响应式</span>
    <span class="token keyword">const</span> depId <span class="token operator">=</span> val<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>id
    <span class="token comment" spellcheck="true">//拿到depId，保证不会重复收集依赖</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>depId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>depId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//如果是数组 循环遍历 将数组中的每一项都调用_traverse 收集依赖</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i <span class="token operator">=</span> val<span class="token punctuation">.</span>length
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//如果是对象 </span>
    keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>通过<code>_traverse</code>方法，就实现了对数组或者对象的深度监听。</p>
<h3 id="vm-set"><a href="#vm-set" class="headerlink" title="vm.$set"></a>vm.$set</h3><h4 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h4><p><code>vm.$set(target,key,value)</code><br>参数：</p>
<ul>
<li>{ Object | Array } <code>target</code></li>
<li>{ string | number  } key</li>
<li>{ any } value</li>
</ul>
<p>返回值：{ Function } unwatch<br>用法：在object上设置一个属性，如果object是响应式的，那么属性被创建之后也会是响应式的，被触发视图更新。该方法主要用来避开Vue不能侦测属性被添加的限制。</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><blockquote>
<p>src/core/observer/index.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/**
 * Set a property on an object. Adds the new property and
 * triggers change notification if the property doesn't
 * already exist.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> any<span class="token punctuation">,</span> val<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//如果是数组 则改变数组的length，使用splice方法在key后面添加一个value</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//使用splice方法，触发数组拦截器，触发依赖收集逻辑</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//如果是对象且key已经存在于对象中，则直接更改对象属性值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//获取Observe实例 如果target已是响应式的 则ob存在</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//target不能是vue实例或者vue实例的根数据对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">"production"</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">"Avoid adding reactive properties to a Vue instance or its root $data "</span> <span class="token operator">+</span>
          <span class="token string">"at runtime - declare it upfront in the data option."</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//如果ob不存在 则target不是响应式对象 则不需要做特殊处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//否则 重新触发defineReactive，进行依赖收集</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这就是vm.$set()的原理。</p>
<h3 id="vm-delete"><a href="#vm-delete" class="headerlink" title="vm.$delete"></a>vm.$delete</h3><h4 id="用法-2"><a href="#用法-2" class="headerlink" title="用法"></a>用法</h4><p><code>vm.$delete(target,key)</code><br>参数：</p>
<ul>
<li>{ Object | Array } <code>target</code></li>
<li>{ string | number  } key</li>
</ul>
<p>用法：删除对象的属性如果对象是响应式的，则可以保证能触发更新视图。</p>
<h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><blockquote>
<p>src/core/instance/state.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> del <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../observer/index'</span>
Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span> <span class="token operator">=</span> del<span class="token punctuation">;</span></code></pre>
<blockquote>
<p>src/core/observer/index.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/**
 * Delete a property and trigger change if necessary.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">del</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//target如果是数组 则使用splice触发依赖</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//如果target是vue实例或者vue实例根数据对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">"production"</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">"Avoid deleting properties on a Vue instance or its root $data "</span> <span class="token operator">+</span>
          <span class="token string">"- just set it to null."</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//如果target上不存在key属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//如果是对象 直接删除 </span>
  <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//如果target不是响应式数据 不做任何处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//否则 触发依赖</span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Vue/源码解读/Observer" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/26/Vue/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Observer/"
    >vue源码解读(一)：Observe</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/26/Vue/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Observer/" class="article-date">
  <time datetime="2020-03-26T14:30:00.000Z" itemprop="datePublished">2020-03-26</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="vue源码解读-一-：Observe"><a href="#vue源码解读-一-：Observe" class="headerlink" title="vue源码解读(一)：Observe"></a>vue源码解读(一)：Observe</h1><h2 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h2><h3 id="变化侦测"><a href="#变化侦测" class="headerlink" title="变化侦测"></a>变化侦测</h3><p>Vue.js会根据数据状态自动生成Dom，并将其渲染到页面之上。Vue.js的渲染是生命式的，我们通过模版来描述状态和Dom之间的联系。<br>通常，在运行时应用内部的状态是不断变化的，那么就需要不停的去渲染页面，但是这个过程中，状态发生了怎样的变化呢？<br>变化侦测就是用来解决这样的问题。它分为两种类型：”推” 和” 拉”。<br>其中<code>Angular</code>和<code>React</code>的变化侦测属于”拉”的类型。当数据发生改变的时候，会发送信号给框架，然后框架内部会进行一个暴力的对比，来找出哪些节点需要重新渲染，这就是<code>Angular</code>的脏检测。而<code>React</code>使用的则是虚拟Dom。<br>Vue.js使用的则是”推”类型。当一个状态发生改变之后，它会自动的发送通知给每一个依赖，让它们进行Dom更新。但是这也是有代价的，当一个状态的依赖越来越多的时候，这种推的过程的内存开销就会随之增大，所以<code>在Vue2.0开始，引入来虚拟Dom，将粒度调整为中等粒度，每一个状态所绑定的依赖不再是具体的节点，而是组件</code>。这样当状态发生变化之后，只需要通知对应的组件，由组件内部使用虚拟Dom进行比较。这样大大的降低来依赖数量，从而降低来依赖跟踪的内存消耗。</p>
<h3 id="如何追踪变化"><a href="#如何追踪变化" class="headerlink" title="如何追踪变化"></a>如何追踪变化</h3><p>追踪一个对象的变化，有两个方法：<code>Object.definePrototype()</code>  和 <code>ES6的proxy</code>。而由于ES6在各浏览器的支持度并不理想，所以在Vue2.0中，依旧使用的是<code>Object.definePrototype()</code>。但是在Vue3.0中，使用的就是<code>proxy</code>了。<br>根据<code>Object.definePrototype()</code>我们可以封装一个函数，来定义一个响应式数据对象。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">==</span> newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span><span class="token number">20</span>
<span class="token punctuation">}</span>
<span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>只要调用函数<code>defineReactive</code>，传入参数data，key和val，即可对data进行监听。当获取data的key属性时，就会触发get；设置key属性时就会触发set。</p>
<h3 id="收集依赖"><a href="#收集依赖" class="headerlink" title="收集依赖"></a>收集依赖</h3><p>所谓依赖，就是和目标对象的属性有一定的联系。而上面我们也通过一个栗子看到来，当我们获取一个对象的属性的时候，对象的访问器属性get就会被触发，那么我们可以不可以在这里进行依赖搜集？当get被触发的时候，将用到该属性的地方搜集起来，等到设置（修改属性值）的时候，即set被触发的时候，通知每一个依赖。<br>所以，最后我们得出结论：<strong>对象的监测，是在getter中收集依赖，在setter中触发依赖。</strong><br>**</p>
<h3 id="依赖保存在哪里"><a href="#依赖保存在哪里" class="headerlink" title="依赖保存在哪里"></a>依赖保存在哪里</h3><p>上一步我们已经知道如何搜集依赖，那么依赖搜集之后，我们将依赖放在哪里呢？<br>思考一下，如果以每一个key都对应一个数组，当key对应的值发生改变之后，遍历数组，触发依赖，那么是不是就可以来？<br>现在我们假设依赖是一个函数，保存在window.target上，那么：<br>修改上面的函数：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//依赖</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">==</span> newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
              <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len <span class="token operator">=</span> dep<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    dep<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>这里我们新增数组dep作为存储搜集的依赖。然后当set被触发的时候，遍历dep，触发依赖。<br>然后我们观测以上代码，我们在变化侦测的方法中，进行依赖搜集的触发，这样写的化，代码的耦合度显得有点高，所以我们需要解耦，将dep抽离出来，单独封装成一个类：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addSub</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">removeSub</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            element<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> pushTarget <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> popTarget <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>然后改造defineReactive：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">'./dep'</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//依赖</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">==</span> newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
              dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="依赖是谁"><a href="#依赖是谁" class="headerlink" title="依赖是谁"></a>依赖是谁</h3><p>上面我们假设依赖是一个函数，window.target。那么它到底是什么？<br>我们知道，收集谁，就是当属性变化之后通知谁。<br>在Vue.js中，我们需要通知的地方，可能是模版、也可能是个watch。那么我们能不能将其抽离出来，封装成类，当属性收集的时候，只将类的实例收集起来，通知也只通知它一个，然后由它去通知其他地方。所以我们将这个类取个名字：Watcher。</p>
<h3 id="什么是Watcher"><a href="#什么是Watcher" class="headerlink" title="什么是Watcher"></a>什么是Watcher</h3><p>在我的理解中，watcher就是一个中介，当属性发生变化的时候通知它，然后它再通知其他地方。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> parsePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../lib/parsePath'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Dep<span class="token punctuation">,</span> <span class="token punctuation">{</span> pushTarget<span class="token punctuation">,</span> popTarget <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dep'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>expOrFn<span class="token punctuation">,</span>cb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsrPath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// window.target = this;</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// window.target = undefined;</span>
        <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>oldValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> bailRE <span class="token operator">=</span> <span class="token regex">/^\w.s]/</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bailRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//使用.将path分割成数组，然后一层层的遍历，即可获取想读的数据</span>
    <span class="token keyword">const</span> segments <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>segments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>在这段代码中，通过在get函数中，将this(即watcher实例)添加到Dep中，然后在读取属性值，就会触发getter，只要触发来getter就会触发依赖搜集逻辑。<br>将依赖注入到Dep中之后，只要属性值发生变化，就会让依赖列表中所有的依赖都执行update方法，也就是Watcher的update方法，而update方法会执行参数中的回调，将新老值传入回调中。</p>
<h3 id="递归侦测所有的key"><a href="#递归侦测所有的key" class="headerlink" title="递归侦测所有的key"></a>递归侦测所有的key</h3><p>现在已经可以侦测到对象的属性值的变化，那么下一步就是将对象所有的属性都可以侦测到。那么我们就需要将其封装成一个Observer类。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Observe</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/**
     * walk会将每一个对象的属性都转换成getter和setter的形式进行监听
     */</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//递归子属性</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//依赖</span>
    <span class="token keyword">let</span> childpOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//返回一个Observe实例</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//依赖搜集</span>
            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            val <span class="token operator">=</span> newVal
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>我们定义类一个Observe类，它将一个正常的object转换为类一个被侦测的object。然后通过判断数据类型，只有Object类型的数据才会调用walk将每一个属性转换为getter/setter形式。</p>
<h3 id="Object的问题"><a href="#Object的问题" class="headerlink" title="Object的问题"></a>Object的问题</h3><p>上面我们接受类Object的数据侦测的方式，是有getter/setter的方式实现的，那么正是由于这种追踪方式，使得一些属性变化不会被侦测到，如新增属性、删除属性。Vue.js的这种实现方式只能侦测一个对象的值的变化，而无法追踪新增属性和删除属性。所有才会导致上述问题。<br>但是在ES6之后，JavaScript提供类元编程的能力，我们可以通过proxy对Object进行元编程。具体请移步<a href="https://es6.ruanyifeng.com/#docs/proxy" target="_blank" rel="noopener">proxy</a>。</p>
<h2 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h2><h3 id="数组的变化侦测"><a href="#数组的变化侦测" class="headerlink" title="数组的变化侦测"></a>数组的变化侦测</h3><p>数组的变化侦测和Object的变化侦测有一点点的不同，下面我们举个🌰看看：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>在上面的代码中，我们向list数组中push了一个元素，但是这并没有触发getter/setter，所以用于Object的侦测方法已经不适合数组了。<br>在上面的代码中，我们还可以知道，我们通过push完成了数组的改变，那么如果我们在push的时候，获取通知，那么是不是就可以完成侦测？<br>所以，我们可以使用自定义的数组方法，通过覆盖数组原型的方法，来实现数组的变化侦测。如图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585213706804-ae301c15-46d9-4f96-bbbe-3e50cdc596ea.png#align=left&display=inline&height=382&name=image.png&originHeight=764&originWidth=1534&size=381500&status=done&style=none&width=767" alt="image.png"><br>我们在数组的原型前加了一层拦截器，拦截数组的操作方法，就可以实现对数组的变化侦测。</p>
<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>那么拦截器是如何实现的呢？<br>首先，我们需要知道哪些方法可以改变数组，我们只需要在拦截器中重写这些方法覆盖数组原型对应的方法即可，没有必要对数组原型进行全方位的覆盖。<br>经过整理，我们知道可以改变数组自身内容的方法有：push、pop、shift、unshift、sort、reverse、slice七种方法。<br>所以，我们可以写出如下代码，对数组原型上的方法进行覆盖：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> originMethods <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token keyword">const</span> arrayProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>originMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span><span class="token string">'pop'</span><span class="token punctuation">,</span><span class="token string">'shift'</span><span class="token punctuation">,</span><span class="token string">'unshift'</span><span class="token punctuation">,</span><span class="token string">'sort'</span><span class="token punctuation">,</span><span class="token string">'reverse'</span><span class="token punctuation">,</span><span class="token string">'slice'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>method <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//缓存原始方法</span>
    <span class="token keyword">const</span> originMethod <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">definePrototype</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">,</span>method<span class="token punctuation">,</span><span class="token punctuation">{</span>
      value<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//todo</span>
        <span class="token keyword">return</span> originMethod<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    enumerable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    writeable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    configerable<span class="token punctuation">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>在上述代码中，我们创造了<code>arrayProto</code>，它继承自<code>Array.prototype</code>，具备其一切的方法；接下来，我们通过遍历<code>methods</code>对其中每一个方法都进行重新封装，让其指向原型上的方法，这样我们使用拦截器拦截数组方法的操作时，使用的仍然是数组原型对象上的方法，而我们只需要在value的箭头函数中，做一些该做的事即可。</p>
<h3 id="使用拦截器覆盖数组方法"><a href="#使用拦截器覆盖数组方法" class="headerlink" title="使用拦截器覆盖数组方法"></a>使用拦截器覆盖数组方法</h3><p>有了拦截器之后，我们要做的就是使用拦截器覆盖Array.prototype，但是我们不能够进行全局覆盖，这样会污染全局的Array，而我们只希望拦截被侦测的数据，即只覆盖那些响应式的数组原型。<br>而将一个数据转换成响应式的，就需要使用Observe，所以我们在Observe中拦截即可。</p>
<blockquote>
<p>具体请查阅源码：/src/core/observer#Observer</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//判断是否支持__proto__</span>
<span class="token keyword">const</span> hasProto <span class="token operator">=</span> <span class="token string">'_proto_'</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//如果支持_proto_属性，则使用protoAugment</span>
<span class="token keyword">function</span> <span class="token function">protoAugment</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>_proto_ <span class="token operator">=</span> src
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//否则使用copyAugment</span>
<span class="token keyword">function</span> <span class="token function">copyAugment</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// console.log(target,src,keys)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token function">def</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>
  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>
  vmCount<span class="token punctuation">:</span> number<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number of vms that have this object as root $data</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">"__ob__"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/**
   * Walk through all properties and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */</span>
  <span class="token function">walk</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/**
   * Observe a list of Array items.
   */</span>
  <span class="token function">observeArray</span><span class="token punctuation">(</span>items<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>上面我们通过上述代码，我们新增方法<code>hasProto</code>来判断浏览器是否支持<strong>proto</strong>属性，如果支持，则直接使用该属性设置对象的原型，否则使用递归复制到对象原型上。将拦截器设置在value.<strong>proto</strong>上之后，当用户使用这些方法之后，访问的不再是数组原型的方法，而是我们自定义的方法。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585229094153-0ce1f29f-5f6d-4a64-8eee-b102a4563cfa.png#align=left&display=inline&height=402&name=image.png&originHeight=804&originWidth=1370&size=314305&status=done&style=none&width=685" alt="image.png"></p>
<h3 id="收集依赖-1"><a href="#收集依赖-1" class="headerlink" title="收集依赖"></a>收集依赖</h3><p>大家还记得我们前面提到的🌰吗？</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>在这里，我们向数组中添加来一个元素。请注意，我们是在<code>this</code>对象上的<code>list</code>属性添加一个元素。所以，当我们访问list数组的时候，需要使用<code>this.list</code>。所以，我们就可以使用Object.definePrototype()来监听访问，当用户访问list时，一定会触发list的getter。<br><strong>所以，数组的依赖收集也是在getter中进行。在拦截器中触发依赖。</strong></p>
<h3 id="依赖收集到哪里"><a href="#依赖收集到哪里" class="headerlink" title="依赖收集到哪里"></a>依赖收集到哪里</h3><p>在vue.js中依赖是被收集到Observe中的。</p>
<blockquote>
<p>具体请查阅源码：/src/core/observer#defineReactive</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//依赖</span>
    <span class="token keyword">let</span> childpOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//返回一个Observe实例</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//依赖搜集</span>
            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>childpOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                childpOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// for(let i = 0; i &lt; dep.length; i++){</span>
            <span class="token comment" spellcheck="true">//     //遍历 依次触发依赖</span>
            <span class="token comment" spellcheck="true">//     dep[i](newVal,val);</span>
            <span class="token comment" spellcheck="true">// }</span>
            val <span class="token operator">=</span> newVal
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/**
 * 尝试新建一个observe
 * 如果创建成功 返回新的observe实例
 * 否则返回已存在的observe实例
 */</span>
<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> asRootData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">let</span> ob
    <span class="token comment" spellcheck="true">//如果value已经是响应式的数据 则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'_ob_'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>_ob_ <span class="token keyword">instanceof</span> <span class="token class-name">Observe</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> value<span class="token punctuation">.</span>_ob_
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ob
<span class="token punctuation">}</span></code></pre>
<p>在上面我们创建来一个函数observe，用于新建Observe实例，如果value已经是响应式数据，即直接返回，否则创建一个新的Observe实例返回。避免来重复侦测value变化。而且，我们可以看到，在新建Observe实例时，vue.js是将实例挂载在value的_ob_属性上，所以细心的同学肯定也会发现我们平时开发时，一些响应式数据属性上总有一个_ob_属性，其实这就是Observe实例。</p>
<h3 id="在拦截器中获取依赖"><a href="#在拦截器中获取依赖" class="headerlink" title="在拦截器中获取依赖"></a>在拦截器中获取依赖</h3><p>然后我们注意这一段代码：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//在此搜集依赖  保存在Observe</span>
<span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'_ob_'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//将Observe挂载到 对象的_ob_属性上</span></code></pre>
<p>这段代码将dep实例挂载这value上，然后将this设置在_ob_属性上，所以，我们后期就可以通过value的_ob_属性获取对应的依赖。</p>
<h3 id="触发依赖"><a href="#触发依赖" class="headerlink" title="触发依赖"></a>触发依赖</h3><blockquote>
<p>具体请查阅源码：/src/core/observer/array.js</p>
</blockquote>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/*
 * not type checking this file because flow doesn't play well with
 * dynamically accessing methods on Array prototype
 */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> def <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>

<span class="token keyword">const</span> arrayProto <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>

<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true">/**
 * Intercept mutating methods and emit events
 */</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// cache original method</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> mutator <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> original<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// notify change</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>在上面的代码中，通过使用<code>ob.dep.notify()</code>来通知依赖数据发生来改变。</p>
<h3 id="侦测数组中元素的变化"><a href="#侦测数组中元素的变化" class="headerlink" title="侦测数组中元素的变化"></a>侦测数组中元素的变化</h3><p>前面提到的侦测数组变化，指的是数组本身的变化，比如：新增、删除一个元素。那么，如果数组中某一元素是对象，对象的属性值发生变化也是要侦测的。也就是说响应式数据的子项也是要被侦听的。所以我们需要递归的遍历数组，将数组中的每一项都设置成响应式的。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">...</span><span class="token operator">...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span><span class="token operator">...</span>

 <span class="token comment" spellcheck="true">/**
   * Observe a list of Array items.
   */</span>
  <span class="token function">observeArray</span><span class="token punctuation">(</span>items<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<h3 id="侦测新增元素的变化"><a href="#侦测新增元素的变化" class="headerlink" title="侦测新增元素的变化"></a>侦测新增元素的变化</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span></code></pre>
<h3 id="Array的问题"><a href="#Array的问题" class="headerlink" title="Array的问题"></a>Array的问题</h3><p>前面说过，Vue.js对数组实现侦测的方式是在数组原型上进行监听的，所以有一些方法改变数组是Vue.js是无法监测到的，如：<code>this.list.length = 0、this.list[0] = 2</code>，这样并不会触发re-render或者watcher。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Code/07" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/26/Code/07/"
    >手写Promise A+</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/26/Code/07/" class="article-date">
  <time datetime="2020-03-26T08:00:00.000Z" itemprop="datePublished">2020-03-26</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="手写Promise-A"><a href="#手写Promise-A" class="headerlink" title="手写Promise A+"></a>手写Promise A+</h1><p>Promise 是异步编程的一种解决方案。ES6 将其写进了语言标准，统一了用法，原生提供了<code>Promise</code>对象。<br>所谓<code>Promise</code>，简单说就是一个容器，里面保存着某个未来才会结束的事件（通常是一个异步操作）的结果。从语法上说，Promise 是一个对象，从它可以获取异步操作的消息。Promise 提供统一的 API，各种异步操作都可以用同样的方法进行处理。<br><code>Promise</code>对象有以下两个特点：</p>
<ul>
<li>对象的状态不受外界影响</li>
<li>一旦状态改变，就不会再变，任何时候都可以得到这个结果。</li>
</ul>
<h3 id="基础实现Promise"><a href="#基础实现Promise" class="headerlink" title="基础实现Promise"></a>基础实现Promise</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//promise的状态 默认pending</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//promise的值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//成功的回调函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//失败的回调函数</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//promise的状态变为resolved 之后，遍历调用成功回调函数</span>
          self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//promise的状态变为rejected 之后，遍历调用成功回调函数</span>
          self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>在上面的代码中，我们建立一个<code>Promise</code>函数，在函数中添加了<code>Promise</code>的返回值<code>value</code>、成功的回调函数队列<code>onResolvedCallback</code>、失败的函数回调队列<code>onRejectedCallback</code>。<br>然后编写了函数的<code>resolve</code>、<code>reject</code>方法，在方法中使用<code>setTimeout</code>来实现异步。方法都接受一个参数，表示当Promise状态变为resolved、rejected时返回值。最后，遍历对应的回调队列，触发队列中的每一个回调函数，并且将value传入。</p>
<h3 id="实现then"><a href="#实现then" class="headerlink" title="实现then"></a>实现then</h3><p><code>then</code>方法的第一个参数是<code>resolved</code>状态的回调函数，第二个参数（可选）是<code>rejected</code>状态的回调函数。<br><code>then</code>方法返回的是一个新的<code>Promise</code>实例（注意，不是原来那个<code>Promise</code>实例）。因此可以采用链式写法，即<code>then</code>方法后面再调用另一个<code>then</code>方法。</p>
<pre class=" language-javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">,</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//避免传入的不是函数</span>
  onFulfilled <span class="token operator">=</span>
        <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> onFulfilled <span class="token punctuation">:</span> value <span class="token operator">=</span><span class="token operator">></span> value
    onRejected <span class="token operator">=</span>
        <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
            <span class="token operator">?</span> onRejected
            <span class="token punctuation">:</span> error <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> error
              <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//缓存this上下文对象 在哪个promise中调用，指向谁</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'RESOLVED'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//成功</span>
        self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//调用成功回调 获取结果</span>
          <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果返回值为新的promise对象 则继续调用then</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//否则直接resolve</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'REJECTED'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//调用回调 获取结果</span>
          <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果返回值为新的promise对象 则继续调用then</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//否则直接resolve</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>在<code>then</code>函数中，我们需要保存调用<code>then</code>函数时的上下文对象，然后根据此时<code>promise</code>的状态，分别进行不同的处理。</p>
<h3 id="实现all"><a href="#实现all" class="headerlink" title="实现all"></a>实现all</h3><p><code>promise.all（）</code>，具有以下特性：</p>
<ol>
<li><em>接收一个 <em>`</em>Promise_`</em> 实例的数组或具有 <em>`</em>Iterator_`_ 接口的对象，_</li>
<li><em>如果元素不是 <em>`</em>Promise_`</em> 对象，则使用 <em>`</em>Promise.resolve_<code>_ 转成 _</code><em>Promise_`</em> 对象_</li>
<li><em>如果全部成功，状态变为 <em>`</em>resolved_`_，返回值将组成一个数组传给回调</em></li>
<li><em>只要有一个失败，状态就变为 <em>`</em>rejected_<code>_，返回值将直接传递给回调_</code>_all() <em>`</em>的返回值也是新的 <em>`</em>Promise_`</em> 对象_</li>
</ol>
<pre class=" language-javascript"><code class="language-javascript">Promisre<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>all <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'arguments must be an array'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        len<span class="token operator">=</span>  promises<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        resolveValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        resolveValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">===</span> len<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>resolveValues<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>ok，这样我们的<code>promise A+</code>基本就简单实现了。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Interview/06" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/21/Interview/06/"
    >CSS常见面试题</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/21/Interview/06/" class="article-date">
  <time datetime="2020-03-21T02:20:00.000Z" itemprop="datePublished">2020-03-21</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/CSS/">CSS</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="CSS常见面试题"><a href="#CSS常见面试题" class="headerlink" title="CSS常见面试题"></a>CSS常见面试题</h1><ol>
<li><strong>介绍一下标准的CSS的盒子模型？与低版本IE的盒子模型有什么不同的？</strong></li>
</ol>
<p>标准盒子模型：宽度=内容的宽度（content）+ border + padding + margin<br>低版本IE盒子模型：宽度=内容宽度（content+border+padding）+ margin</p>
<ol start="2">
<li><strong>box-sizing属性</strong></li>
</ol>
<p>用来控制元素的盒子模型的解析模式，默认为content-box<br>context-box：W3C的标准盒子模型，设置元素的 height/width 属性指的是content部分的高/宽<br>border-box：IE传统盒子模型。设置元素的height/width属性指的是border + padding + content部分 的高/宽</p>
<ol start="3">
<li><strong>CSS选择器有哪些？哪些属性可以继承？CSS优先级算法如何计算？</strong></li>
</ol>
<p>CSS选择符：id选择器(#myid)、类选择器(.myclassname)、标签选择器(div, h1, p)、相邻选择器(h1 + p)、子选择器（ul &gt; li）、后代选择器（li a）、通配符选择器（*）、属性选择器（a[rel=”external”]）、伪类选择器（a:hover, li:nth-child）</p>
<p>可继承的属性：font-size, font-family, color<br>不可继承的样式：border, padding, margin, width, height<br>优先级（就近原则）：!important &gt; [ id &gt; class &gt; tag ]<br>!important 比内联优先级高</p>
<p>元素选择符： 1<br>class选择符： 10<br>id选择符：100<br>元素标签：1000</p>
<ol>
<li>!important声明的样式优先级最高，如果冲突再进行计算。</li>
<li>如果优先级相同，则选择最后出现的样式。</li>
<li>继承得到的样式的优先级最低。</li>
</ol>
<ol start="4">
<li><strong>CSS3新增伪类有那些?</strong></li>
</ol>
<p>p:first-of-type 选择属于其父元素的首个元素<br>p:last-of-type 选择属于其父元素的最后元素<br>p:only-of-type 选择属于其父元素唯一的元素<br>p:only-child 选择属于其父元素的唯一子元素<br>p:nth-child(2) 选择属于其父元素的第二个子元素<br>:enabled :disabled 表单控件的禁用状态。<br>:checked 单选框或复选框被选中。</p>
<ol start="5">
<li><strong>如何居中div？</strong></li>
</ol>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>main<span class="token punctuation">{</span>
  background<span class="token operator">-</span>color<span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
  text<span class="token operator">-</span>align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  vertical<span class="token operator">-</span>align<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
  position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>content<span class="token punctuation">{</span>
  background<span class="token operator">-</span>color<span class="token punctuation">:</span> red<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  top<span class="token punctuation">:</span> <span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">;</span>
  left<span class="token punctuation">:</span> <span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">;</span>
  transform<span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token punctuation">.</span>content<span class="token punctuation">{</span>
  background<span class="token operator">-</span>color<span class="token punctuation">:</span> red<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  top<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  right<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  bottom<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  margin<span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span> </code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>main<span class="token punctuation">{</span>
  background<span class="token operator">-</span>color<span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
  text<span class="token operator">-</span>align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  vertical<span class="token operator">-</span>align<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
  display<span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  align<span class="token operator">-</span>items<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  justify<span class="token operator">-</span>content<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ol start="6">
<li><strong>display有哪些值？说明他们的作用?</strong></li>
</ol>
<ul>
<li>inline（默认）–内联</li>
<li>none–隐藏</li>
<li>block–块显示</li>
<li>table–表格显示</li>
<li>list-item–项目列表</li>
<li>inline-block</li>
</ul>
<ol start="7">
<li><strong>position的值？</strong></li>
</ol>
<ul>
<li>static（默认）：按照正常文档流进行排列；</li>
<li>relative（相对定位）：不脱离文档流，参考自身静态位置通过 top, bottom, left, right 定位；</li>
<li>absolute(绝对定位)：参考距其最近一个不为static的父级元素通过top, bottom, left, right 定位；</li>
<li>fixed(固定定位)：所固定的参照对像是可视窗口。</li>
</ul>
<ol start="8">
<li><strong>请解释一下CSS3的flexbox（弹性盒布局模型）,以及适用场景？</strong></li>
</ol>
<p>该布局模型的目的是提供一种更加高效的方式来对容器中的条目进行布局、对齐和分配空间。在传统的布局方式中，block 布局是把块在垂直方向从上到下依次排列的；而 inline 布局则是在水平方向来排列。弹性盒布局并没有这样内在的方向限制，可以由开发人员自由操作。<br>试用场景：弹性布局适合于移动前端开发，在Android和ios上也完美支持。</p>
<ol start="9">
<li><strong>用纯CSS创建一个三角形的原理是什么？</strong></li>
</ol>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">:</span>root<span class="token punctuation">{</span>
  <span class="token operator">--</span>border<span class="token operator">-</span>width<span class="token punctuation">:</span>100px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>main<span class="token punctuation">{</span>
  width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  margin<span class="token operator">-</span>top<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>main1<span class="token punctuation">{</span>
  border<span class="token operator">-</span>left<span class="token punctuation">:</span> 50px solid transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>right<span class="token punctuation">:</span> 50px solid transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>bottom<span class="token punctuation">:</span> <span class="token keyword">var</span><span class="token punctuation">(</span><span class="token operator">--</span>border<span class="token operator">-</span>width<span class="token punctuation">)</span> solid yellowgreen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>main2<span class="token punctuation">{</span>
  border<span class="token operator">-</span>right<span class="token punctuation">:</span> 100px solid yellowgreen<span class="token punctuation">;</span>
  border<span class="token operator">-</span>bottom<span class="token punctuation">:</span> 50px solid transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>top<span class="token punctuation">:</span> 50px solid transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>main3<span class="token punctuation">{</span>
  border<span class="token operator">-</span>right<span class="token punctuation">:</span> 120px solid yellowgreen<span class="token punctuation">;</span>
  border<span class="token operator">-</span>bottom<span class="token punctuation">:</span> 70px solid transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>top<span class="token punctuation">:</span> 30px solid transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/**********************************************/</span>
<span class="token punctuation">:</span>root <span class="token punctuation">{</span>
  <span class="token operator">--</span>Width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* --Width:100px; */</span>
  <span class="token operator">--</span>border<span class="token operator">-</span>width<span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*三角形 开口向左上*/</span>
<span class="token punctuation">.</span>main <span class="token punctuation">{</span>
  width<span class="token punctuation">:</span> <span class="token keyword">var</span><span class="token punctuation">(</span><span class="token operator">--</span>Width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token keyword">var</span><span class="token punctuation">(</span><span class="token operator">--</span>Width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> <span class="token keyword">var</span><span class="token punctuation">(</span><span class="token operator">--</span>border<span class="token operator">-</span>width<span class="token punctuation">)</span> solid<span class="token punctuation">;</span>
  border<span class="token operator">-</span>color<span class="token punctuation">:</span> yellow red green black<span class="token punctuation">;</span>
  border<span class="token operator">-</span>bottom<span class="token operator">-</span>color<span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/*transparent 表示颜色透明*/</span>
  border<span class="token operator">-</span>right<span class="token operator">-</span>color<span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*扇形 开口向下*/</span>
<span class="token punctuation">.</span>main2 <span class="token punctuation">{</span>
  width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  margin<span class="token operator">-</span>top<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> 100px solid red<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* border-right-color: transparent;
            border-bottom-color: transparent;
            border-left-color: transparent; */</span>
  border<span class="token operator">-</span>color<span class="token punctuation">:</span> #f00 transparent transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>radius<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*等腰梯形*/</span>
<span class="token punctuation">.</span>main3 <span class="token punctuation">{</span>
  margin<span class="token operator">-</span>top<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> 70px solid<span class="token punctuation">;</span>
  border<span class="token operator">-</span>color<span class="token punctuation">:</span> red transparent transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*直角梯形*/</span>
<span class="token punctuation">.</span>main4 <span class="token punctuation">{</span>
  margin<span class="token operator">-</span>top<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> 70px solid<span class="token punctuation">;</span>
  border<span class="token operator">-</span>bottom<span class="token operator">-</span>width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  border<span class="token operator">-</span>color<span class="token punctuation">:</span> red red transparent transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*平行四边形*/</span>
<span class="token punctuation">.</span>main5 <span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  margin<span class="token operator">-</span>top<span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  border<span class="token operator">-</span>width<span class="token punctuation">:</span> 100px 70px<span class="token punctuation">;</span>
  border<span class="token operator">-</span>color<span class="token punctuation">:</span> yellow red green black<span class="token punctuation">;</span>
  border<span class="token operator">-</span>right<span class="token operator">-</span>color<span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>left<span class="token operator">-</span>color<span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
  border<span class="token operator">-</span>top<span class="token operator">-</span>color<span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>main5<span class="token punctuation">:</span><span class="token punctuation">:</span>after <span class="token punctuation">{</span>
  content<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  top<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  right<span class="token punctuation">:</span> <span class="token operator">-</span>140px<span class="token punctuation">;</span>
  border<span class="token operator">-</span>right<span class="token punctuation">:</span>70px solid transparent <span class="token punctuation">;</span>
  border<span class="token operator">-</span>left<span class="token punctuation">:</span>70px solid transparent <span class="token punctuation">;</span>
  border<span class="token operator">-</span>top<span class="token punctuation">:</span>100px solid red <span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ol start="10">
<li><strong>常见的兼容性问题？</strong></li>
</ol>
<ul>
<li>同浏览器的标签默认的margin和padding不一样。*{margin:0;padding:0;}</li>
<li>IE6双边距bug：块属性标签float后，又有横行的margin情况下，在IE6显示margin比设置的大。hack：display:inline;将其转化为行内属性</li>
<li>设置较小高度标签（一般小于10px），在IE6，IE7中高度超出自己设置高度。hack：给超出高度的标签设置overflow:hidden;或者设置行高line-height 小于你设置的高度。</li>
<li>Chrome 中文界面下默认会将小于 12px 的文本强制按照 12px 显示,可通过加入 CSS 属性 -webkit-text-size-adjust: none; 解决。</li>
</ul>
<p>**</p>
<ol start="11">
<li><strong>display:none与visibility：hidden的区别？</strong></li>
</ol>
<p>display：none 不显示对应的元素，在文档布局中不再分配空间（回流+重绘）<br>visibility：hidden 隐藏对应元素，在文档布局中仍保留原来的空间（重绘）</p>
<ol start="12">
<li><strong>position跟display、overflow、float这些特性相互叠加后会怎么样？</strong></li>
</ol>
<p>display属性规定元素应该生成的框的类型；position属性规定元素的定位类型；float属性是一种布局方式，定义元素在哪个方向浮动。<br>类似于优先级机制：position：absolute/fixed优先级最高，有他们在时，float不起作用，display值需要调整。float 或者absolute定位的元素，只能是块元素或表格。</p>
<ol start="13">
<li><strong>对BFC规范(块级格式化上下文：block formatting context)的理解？</strong></li>
</ol>
<p>BFC规定了内部的Block Box如何布局。<br>定位方案：</p>
<ol>
<li>内部的Box会在垂直方向上一个接一个放置。</li>
<li>Box垂直方向的距离由margin决定，属于同一个BFC的两个相邻Box的margin会发生重叠。</li>
<li>每个元素的margin box 的左边，与包含块border box的左边相接触。</li>
<li>BFC的区域不会与float box重叠。</li>
<li>BFC是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素。</li>
<li>计算BFC的高度时，浮动元素也会参与计算。</li>
</ol>
<p>满足下列条件之一就可触发BFC</p>
<ol>
<li>根元素，即html</li>
<li>float的值不为none（默认）</li>
<li>overflow的值不为visible（默认）</li>
<li>display的值为inline-block、table-cell、table-caption</li>
<li>position的值为absolute或fixed</li>
</ol>
<p>**</p>
<ol start="14">
<li><strong>为什么会出现浮动和什么时候需要清除浮动？清除浮动的方式？</strong></li>
</ol>
<p>浮动元素碰到包含它的边框或者浮动元素的边框停留。由于浮动元素不在文档流中，所以文档流的块框表现得就像浮动框不存在一样。浮动元素会漂浮在文档流的块框上。<br>浮动带来的问题：</p>
<ol>
<li>父元素的高度无法被撑开，影响与父元素同级的元素</li>
<li>与浮动元素同级的非浮动元素（内联元素）会跟随其后</li>
<li>若非第一个元素浮动，则该元素之前的元素也需要浮动，否则会影响页面显示的结构。</li>
</ol>
<p>清除浮动的方式：</p>
<ol>
<li>父级div定义height</li>
<li>最后一个浮动元素后加空div标签 并添加样式clear:both。</li>
<li>包含浮动元素的父标签添加样式overflow为hidden或auto。</li>
<li>父级div定义zoom</li>
<li>伪类（最佳）</li>
</ol>
<p>最佳实现方法：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/*清除浮动，将该class写在浮动元素的父级元素或父级以上的 元素*/</span>

<span class="token punctuation">.</span>clearfix<span class="token punctuation">:</span>after <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">"."</span><span class="token punctuation">;</span>
    display<span class="token punctuation">:</span> block<span class="token punctuation">;</span>
    height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    font<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    clear<span class="token punctuation">:</span> both<span class="token punctuation">;</span>
    visibility<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/*兼容ie*/</span>

<span class="token punctuation">.</span>clearfix <span class="token punctuation">{</span>
    zoom<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>**</p>
<ol start="15">
<li><strong>CSS优化、提高性能的方法有哪些？</strong><ol>
<li>避免过度约束</li>
<li>避免后代选择符</li>
<li>避免链式选择符</li>
<li>使用紧凑的语法</li>
<li>避免不必要的命名空间</li>
<li>避免不必要的重复</li>
<li>最好使用表示语义的名字。一个好的类名应该是描述他是什么而不是像什么</li>
<li>避免！important，可以选择其他选择器</li>
<li>尽可能的精简规则，你可以合并不同类里的重复规则**</li>
</ol>
</li>
<li><strong>浏览器是怎样解析CSS选择器的？</strong></li>
</ol>
<p>CSS选择器的解析是从右向左解析的。若从左向右的匹配，发现不符合规则，需要进行回溯，会损失很多性能。若从右向左匹配，先找到所有的最右节点，对于每一个节点，向上寻找其父节点直到找到根元素或满足条件的匹配规则，则结束这个分支的遍历。两种匹配规则的性能差别很大，是因为从右向左的匹配在第一步就筛选掉了大量的不符合条件的最右节点（叶子节点），而从左向右的匹配规则的性能都浪费在了失败的查找上面。<br>而在 CSS 解析完毕后，需要将解析的结果与 DOM Tree 的内容一起进行分析建立一棵 Render Tree，最终用来进行绘图。在建立 Render Tree 时（WebKit 中的「Attachment」过程），浏览器就要为每个 DOM Tree 中的元素根据 CSS 的解析结果（Style Rules）来确定生成怎样的 Render Tree。</p>
<ol start="17">
<li><strong>margin和padding分别适合什么场景使用？</strong></li>
</ol>
<p>何时使用margin：</p>
<ol>
<li>需要在border外侧添加空白</li>
<li>空白处不需要背景色</li>
<li>上下相连的两个盒子之间的空白，需要相互抵消时。</li>
</ol>
<p>何时使用padding：</p>
<ol>
<li>需要在border内侧添加空白</li>
<li>空白处需要背景颜色</li>
<li>上下相连的两个盒子的空白，希望为两者之和。</li>
</ol>
<p>兼容性的问题：在IE5 IE6中，为float的盒子指定margin时，左侧的margin可能会变成两倍的宽度。通过改变padding或者指定盒子的display：inline解决。</p>
<ol start="18">
<li><strong>全屏滚动的原理是什么？用到了CSS的哪些属性？</strong></li>
</ol>
<p>原理：有点类似于轮播，整体的元素一直排列下去，假设有5个需要展示的全屏页面，那么高度是500%，只是展示100%，剩下的可以通过transform进行y轴定位，也可以通过margin-top实现。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>title<span class="token operator">></span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span>
    <span class="token operator">&lt;</span>style<span class="token operator">></span>
        <span class="token punctuation">.</span>wrap<span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
            overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>mian<span class="token punctuation">{</span>
            height<span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
            width<span class="token punctuation">:</span> 1000px<span class="token punctuation">;</span>
            overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
            animation<span class="token punctuation">:</span> identifier 10s 1s linear infinite<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>mian div<span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
            height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            float<span class="token punctuation">:</span> left<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>box1<span class="token punctuation">{</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> red<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>box2<span class="token punctuation">{</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> yellow<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>box3<span class="token punctuation">{</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>box4<span class="token punctuation">{</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> purple<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span>box5<span class="token punctuation">{</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> pink<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        @keyframes identifier <span class="token punctuation">{</span>
            <span class="token number">0</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token number">20</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token operator">-</span>200px<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token number">40</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token operator">-</span>400px<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token number">60</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token operator">-</span>600px<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token number">80</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token operator">-</span>800px<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token number">100</span><span class="token operator">%</span> <span class="token punctuation">{</span>
                transform<span class="token punctuation">:</span> <span class="token function">translateX</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
   <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"wrap"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"mian"</span><span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box1"</span><span class="token operator">></span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box2"</span><span class="token operator">></span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box3"</span><span class="token operator">></span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box4"</span><span class="token operator">></span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box5"</span><span class="token operator">></span><span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre>
<ol start="19">
<li><strong>::before 和 :after中双冒号和单冒号有什么区别和作用?</strong><ol>
<li>冒号(:)用于CSS3伪类，双冒号(::)用于CSS3伪元素。</li>
<li>::before就是以一个子元素的存在，定义在元素主体内容之前的一个伪元素。并不存在于dom之中，只存在在页面之中。</li>
</ol>
</li>
</ol>
<p>:before 和 :after 这两个伪元素，是在CSS2.1里新出现的。起初，伪元素的前缀使用的是单冒号语法，但随着Web的进化，在CSS3的规范里，伪元素的语法被修改成使用双冒号，成为::before ::after<br>**</p>
<ol start="20">
<li><strong>你对line-height是如何理解的？</strong></li>
</ol>
<p>行高是指一行文字的高度，具体说是两行文字间基线的距离。CSS中起高度作用的是height和line-height，没有定义height属性，最终其表现作用一定是line-height。<br>单行文本垂直居中：把line-height值设置为height一样大小的值可以实现单行文字的垂直居中，其实也可以把height删除。<br>多行文本垂直居中：需要设置display属性为inline-block。</p>
<ol start="21">
<li><strong>怎么让Chrome支持小于12px 的文字？</strong></li>
</ol>
<p><strong><code>font-size: 20px;-webkit-transform: scale(0.8);</code></strong></p>
<ol start="22">
<li><strong>让页面里的字体变清晰，变细用CSS怎么做？</strong></li>
</ol>
<p><strong><code>-webkit-font-smoothing：antialiased</code></strong></p>
<ol start="23">
<li><strong>如果需要手动写动画，你认为最小时间间隔是多久，为什么？</strong></li>
</ol>
<p>多数显示器默认频率是60Hz，即1秒刷新60次，所以理论上最小间隔为1/60＊1000ms ＝ 16.7ms。</p>
<ol start="24">
<li><strong>li与li之间有看不见的空白间隔是什么原因引起的？有什么解决办法？</strong></li>
</ol>
<p>行框的排列会受到中间空白（回车空格）等的影响，因为空格也属于字符,这些空白也会被应用样式，占据空间，所以会有间隔，把字符大小设为0，就没有空格了。<br>解决方法：</p>
<ol>
<li><p>可以将<li>代码全部写在一排</p>
</li>
<li><p>浮动li中float：left</p>
</li>
<li><p>在ul中用font-size：0（谷歌不支持）；可以使用letter-space：-3px</p>
</li>
</ol>
<p>**</p>
<ol start="25">
<li><strong>png、jpg、gif 这些图片格式解释一下，分别什么时候用。有没有了解过webp？</strong></li>
</ol>
<p><strong>png：</strong><br>特点：支持无损压缩、体积大、质量好、支持透明<br>使用场景：png在处理线条和颜色对比方面有优势，所以经常会被用来做logo或者颜色简单且对比强烈的背景图<br><strong>jpg/jpeg：</strong><br>特点：有损压缩、体积小、加载快、不支持透明<br>使用场景：适用于颜色丰富的场景、如背景图、轮播图、banner图等。<br><strong>svg：</strong><br>特点：文本文件、体积小、不失真、兼容性好<br>使用场景：将 SVG 写入独立文件后引入 HTML<br><strong>base64 :</strong><br>特点： 文本文件、基于编码、小图标解决方案<br>使用场景：小图标<br><strong>webp：</strong></p>
<blockquote>
<p>WebP 是 Google 专为 Web 开发的一种旨在加快图片加载速度的图片格式，它支持有损压缩和无损压缩</p>
</blockquote>
<p>特点：兼容png和jpg的优点，但是有兼容性问题。</p>
<ol start="26">
<li><strong>CSS属性overflow属性定义溢出元素内容区的内容会如何处理?</strong></li>
</ol>
<ul>
<li>参数是scroll时候，必会出现滚动条。</li>
<li>参数是auto时候，子元素内容大于父元素时出现滚动条。</li>
<li>参数是visible时候，溢出的内容出现在父元素之外。</li>
<li>参数是hidden时候，溢出隐藏。</li>
</ul>
<ol start="27">
<li><strong>阐述一下CSS Sprites</strong></li>
</ol>
<p>将一个页面涉及到的所有图片都包含到一张大图中去，然后利用CSS的 background-image，background- repeat，background-position 的组合进行背景定位。利用CSS Sprites能很好地减少网页的http请求，从而大大的提高页面的性能；CSS Sprites能减少图片的字节。</p>
<ol start="28">
<li><strong>div垂直居中 左右10px 宽为高的2倍 内容垂直居中</strong></li>
</ol>
<p>关键点：padding-top、padding-bottom、margin-top、margin-bottom为百分比的时候，都是相对于父元素的width。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span>

<span class="token operator">&lt;</span>head<span class="token operator">></span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>title<span class="token operator">></span>div垂直居中，左右10px，高度始终为宽度一半<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span>
    <span class="token operator">&lt;</span>style<span class="token operator">></span>
        <span class="token operator">*</span> <span class="token punctuation">{</span>
            margin<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            padding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        html<span class="token punctuation">,</span>
        body <span class="token punctuation">{</span>
            height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>outer<span class="token operator">-</span>wrap <span class="token punctuation">{</span>
            height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            margin<span class="token punctuation">:</span> <span class="token number">0</span> 10px<span class="token punctuation">;</span>
            background<span class="token operator">-</span>color<span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span>
            display<span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
            align<span class="token operator">-</span>items<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>inner_wrapper <span class="token punctuation">{</span>
            background<span class="token punctuation">:</span> red<span class="token punctuation">;</span>
            position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
            width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            padding<span class="token operator">-</span>bottom<span class="token punctuation">:</span> <span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>text <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
            display<span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
            align<span class="token operator">-</span>items<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
            justify<span class="token operator">-</span>content<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span>

<span class="token operator">&lt;</span>body<span class="token operator">></span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"outer-wrap"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"inner_wrapper"</span><span class="token operator">></span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"text"</span><span class="token operator">></span>A<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre>
<p>第二种：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">.</span>wrapper <span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>box<span class="token punctuation">{</span>
  margin<span class="token operator">-</span>left<span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>100vw <span class="token operator">-</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>50vw <span class="token operator">-</span> 10px<span class="token punctuation">)</span><span class="token punctuation">;</span>
  background<span class="token operator">-</span>color<span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span>
  display<span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  align<span class="token operator">-</span>items<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  justify<span class="token operator">-</span>content<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ol start="29">
<li>**</li>
</ol>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Interview/08" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/15/Interview/08/"
    >webpack面试题集锦</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/15/Interview/08/" class="article-date">
  <time datetime="2020-03-15T02:20:00.000Z" itemprop="datePublished">2020-03-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/webpack/">webpack</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="webpack面试集锦"><a href="#webpack面试集锦" class="headerlink" title="webpack面试集锦"></a>webpack面试集锦</h1><h3 id="Webpack构建流程简单说一下"><a href="#Webpack构建流程简单说一下" class="headerlink" title="Webpack构建流程简单说一下"></a>Webpack构建流程简单说一下</h3><p>Webpack 的运行流程是一个串行的过程，从启动到结束会依次执行以下流程：</p>
<ul>
<li><p><code>初始化参数</code>：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数</p>
</li>
<li><p><code>开始编译</code>：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译</p>
</li>
<li><p><code>确定入口</code>：根据配置中的 entry 找出所有的入口文件</p>
</li>
<li><p><code>编译模块</code>：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理</p>
</li>
<li><p><code>完成模块编译</code>：在经过第4步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系</p>
</li>
<li><p><code>输出资源</code>：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会</p>
</li>
<li><p><code>输出完成</code>：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统</p>
</li>
</ul>
<p>在以上过程中，<code>Webpack</code> 会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用 Webpack 提供的 API 改变 Webpack 的运行结果。</p>
<h3 id="那你再说一说Loader和Plugin的区别？"><a href="#那你再说一说Loader和Plugin的区别？" class="headerlink" title="那你再说一说Loader和Plugin的区别？"></a>那你再说一说Loader和Plugin的区别？</h3><p><code>Loader</code> 本质就是一个函数，在该函数中对接收到的内容进行转换，返回转换后的结果。<br>因为 Webpack 只认识 JavaScript，所以 Loader 就成了翻译官，对其他类型的资源进行转译的预处理工作。<br><code>Plugin</code> 就是插件，基于事件流框架 <code>Tapable</code>，插件可以扩展 Webpack 的功能，在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。<br><code>Loader</code> 在 module.rules 中配置，作为模块的解析规则，类型为数组。每一项都是一个 Object，内部包含了 test(类型文件)、loader、options (参数)等属性。<br><code>Plugin</code> 在 plugins 中单独配置，类型为数组，每一项是一个 Plugin 的实例，参数都通过构造函数传入。</p>
<h3 id="source-map是什么？生产环境怎么用？"><a href="#source-map是什么？生产环境怎么用？" class="headerlink" title="source map是什么？生产环境怎么用？"></a>source map是什么？生产环境怎么用？</h3><p>**<code>source map</code> 是将编译、打包、压缩后的代码映射回源代码的过程。打包压缩后的代码不具备良好的可读性，想要调试源码就需要 soucre map。<br>map文件只要不打开开发者工具，浏览器是不会加载的。<br>线上环境一般有三种处理方案：</p>
<ul>
<li><p><code>hidden-source-map</code>：借助第三方错误监控平台 Sentry 使用</p>
</li>
<li><p><code>nosources-source-map</code>：只会显示具体行数以及查看源代码的错误栈。安全性比 sourcemap 高</p>
</li>
<li><p><code>sourcemap</code>：通过 nginx 设置将 .map 文件只对白名单开放(公司内网)</p>
</li>
</ul>
<p>注意：避免在生产中使用 <code>inline-</code> 和 <code>eval-</code>，因为它们会增加 bundle 体积大小，并降低整体性能。<br>**</p>
<h3 id="文件监听原理呢？"><a href="#文件监听原理呢？" class="headerlink" title="文件监听原理呢？"></a>文件监听原理呢？</h3><p>在发现源码发生变化时，自动重新构建出新的输出文件。<br>Webpack开启监听模式，有两种方式：</p>
<ul>
<li>启动 webpack 命令时，带上 –watch 参数</li>
<li>在配置 webpack.config.js 中设置 watch:true</li>
</ul>
<p>缺点：每次需要手动刷新浏览器<br>原理：轮询判断文件的最后编辑时间是否变化，如果某个文件发生了变化，并不会立刻告诉监听者，而是先缓存起来，等 <code>aggregateTimeout</code> 后再执行</p>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token keyword">export</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    
  <span class="token comment" spellcheck="true">// 默认false,也就是不开启    </span>
  watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    
  <span class="token comment" spellcheck="true">// 只有开启监听模式时，watchOptions才有意义    </span>
  watchOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>        
    <span class="token comment" spellcheck="true">// 默认为空，不监听的文件或者文件夹，支持正则匹配        </span>
    ignored<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>        
    <span class="token comment" spellcheck="true">// 监听到变化发生后会等300ms再去执行，默认300ms        </span>
    aggregateTimeout<span class="token punctuation">:</span><span class="token number">300</span><span class="token punctuation">,</span>       
    <span class="token comment" spellcheck="true">// 判断文件是否发生变化是通过不停询问系统指定文件有没有变化实现的，默认每秒问1000次        </span>
    poll<span class="token punctuation">:</span><span class="token number">1000</span>    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="使用webpack开发时，你用过哪些可以提高效率的插件？"><a href="#使用webpack开发时，你用过哪些可以提高效率的插件？" class="headerlink" title="使用webpack开发时，你用过哪些可以提高效率的插件？"></a>使用webpack开发时，你用过哪些可以提高效率的插件？</h3><ul>
<li><p><code>webpack-dashboard</code>：可以更友好的展示相关打包信息。</p>
</li>
<li><p><code>webpack-merge</code>：提取公共配置，减少重复配置代码</p>
</li>
<li><p><code>speed-measure-webpack-plugin</code>：简称 SMP，分析出 Webpack 打包过程中 Loader 和 Plugin 的耗时，有助于找到构建过程中的性能瓶颈。</p>
</li>
<li><p><code>size-plugin</code>：监控资源体积变化，尽早发现问题</p>
</li>
<li><p><code>HotModuleReplacementPlugin</code>：模块热替换</p>
</li>
</ul>
<h3 id="Webpack-的热更新原理"><a href="#Webpack-的热更新原理" class="headerlink" title="Webpack 的热更新原理"></a>Webpack 的热更新原理</h3><p><code>Webpack</code> 的热更新又称热替换（<code>Hot Module Replacement</code>），缩写为 <code>HMR</code>。 这个机制可以做到不用刷新浏览器而将新变更的模块替换掉旧的模块。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585037626497-96d400df-62d6-47e5-9012-a5d781d5b676.png#align=left&display=inline&height=688&name=image.png&originHeight=837&originWidth=805&size=312210&status=done&style=none&width=662" alt="image.png"><br>上图是webpack 配合 webpack-dev-server 进行应用开发的模块热更新流程图。</p>
<ul>
<li>上图底部红色框内是服务端，而上面的橙色框是浏览器端。</li>
<li>绿色的方框是 webpack 代码控制的区域。蓝色方框是 webpack-dev-server 代码控制的区域，洋红色的方框是文件系统，文件修改后的变化就发生在这，而青色的方框是应用本身。</li>
</ul>
<p>上图显示了我们修改代码到模块热更新完成的一个周期，通过深绿色的阿拉伯数字符号已经将 HMR 的整个过程标识了出来。</p>
<ol>
<li>第一步，在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包，并将打包后的代码通过简单的 JavaScript 对象保存在内存中。</li>
<li>第二步是 webpack-dev-server 和 webpack 之间的接口交互，而在这一步，主要是 dev-server 的中间件 webpack-dev-middleware 和 webpack 之间的交互，webpack-dev-middleware 调用 webpack 暴露的 API对代码变化进行监控，并且告诉 webpack，将代码打包到内存中。</li>
<li>第三步是 webpack-dev-server 对文件变化的一个监控，这一步不同于第一步，并不是监控代码变化重新打包。当我们在配置文件中配置了<a href="https://link.zhihu.com/?target=https%3A//webpack.js.org/configuration/dev-server/%23devserver-watchcontentbase">devServer.watchContentBase</a> 为 true 的时候，Server 会监听这些配置文件夹中静态文件的变化，变化后会通知浏览器端对应用进行 live reload。注意，这儿是浏览器刷新，和 HMR 是两个概念。</li>
<li>第四步也是 webpack-dev-server 代码的工作，该步骤主要是通过 <a href="https://link.zhihu.com/?target=https%3A//github.com/sockjs/sockjs-client">sockjs</a>（webpack-dev-server 的依赖）在浏览器端和服务端之间建立一个 websocket 长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端，同时也包括第三步中 Server 监听静态文件变化的信息。浏览器端根据这些 socket 消息进行不同的操作。当然服务端传递的最主要信息还是新模块的 hash 值，后面的步骤根据这一 hash 值来进行模块热替换。</li>
<li>webpack-dev-server/client 端并不能够请求更新的代码，也不会执行热更模块操作，而把这些工作又交回给了 webpack，webpack/hot/dev-server 的工作就是根据 webpack-dev-server/client 传给它的信息以及 dev-server 的配置决定是刷新浏览器呢还是进行模块热更新。当然如果仅仅是刷新浏览器，也就没有后面那些步骤了。</li>
<li>HotModuleReplacement.runtime 是客户端 HMR 的中枢，它接收到上一步传递给他的新模块的 hash 值，它通过 JsonpMainTemplate.runtime 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的模块的 hash 值，获取到更新列表后，该模块再次通过 jsonp 请求，获取到最新的模块代码。这就是上图中 7、8、9 步骤。</li>
<li>而第 10 步是决定 HMR 成功与否的关键步骤，在该步骤中，HotModulePlugin 将会对新旧模块进行对比，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。</li>
<li>最后一步，当 HMR 失败后，回退到 live reload 操作，也就是进行浏览器刷新来获取最新打包代码。</li>
</ol>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/30669007" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/30669007</a><br>HMR的核心就是客户端从服务端拉去更新后的文件，准确的说是 chunk diff (chunk 需要更新的部分)，实际上 webpack-dev-server(WDS) 与浏览器之间维护了一个 <code>Websocket</code>，当本地资源发生变化时，WDS 会向浏览器推送更新，并带上构建时的 hash，让客户端与上一次资源进行对比。客户端对比出差异后会向 WDS 发起 <code>Ajax</code> 请求来获取更改内容(文件列表、hash)，这样客户端就可以再借助这些信息继续向 WDS 发起 <code>jsonp</code> 请求获取该chunk的增量更新。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="如何对bundle体积进行监控和分析？"><a href="#如何对bundle体积进行监控和分析？" class="headerlink" title="如何对bundle体积进行监控和分析？"></a>如何对bundle体积进行监控和分析？</h3><p><code>VSCode</code> 中有一个插件 <code>Import Cost</code> 可以帮助我们对引入模块的大小进行实时监测，还可以使用 <code>webpack-bundle-analyzer</code> 生成 <code>bundle</code> 的模块组成图，显示所占体积。</p>
<h3 id="文件指纹是什么？怎么用？"><a href="#文件指纹是什么？怎么用？" class="headerlink" title="文件指纹是什么？怎么用？"></a>文件指纹是什么？怎么用？</h3><p>文件指纹是打包后输出的文件名的后缀。</p>
<ul>
<li><p><code>Hash</code>：和整个项目的构建相关，只要项目文件有修改，整个项目构建的 hash 值就会更改</p>
</li>
<li><p><code>Chunkhash</code>：和 Webpack 打包的 chunk 有关，不同的 entry 会生出不同的 chunkhash</p>
</li>
<li><p><code>Contenthash</code>：根据文件内容来定义 hash，文件内容不变，则 contenthash 不变</p>
</li>
</ul>
<p>js文件指纹设置</p>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    
      entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        
      app<span class="token punctuation">:</span> <span class="token string">'./scr/app.js'</span>    
    <span class="token punctuation">}</span><span class="token punctuation">,</span>    
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>       
          filename<span class="token punctuation">:</span> <span class="token string">'[name][chunkhash:8].js'</span><span class="token punctuation">,</span>        
        path<span class="token punctuation">:</span>__dirname <span class="token operator">+</span> <span class="token string">'/dist'</span>    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>css设置文件指纹</p>
<pre class=" language-javascript"><code class="language-javascript">plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`[name][contenthash:8].css`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span></code></pre>
<p>图片的文件指纹<br>设置file-loader的name，使用hash。<br>占位符名称及含义</p>
<ul>
<li>ext     资源后缀名</li>
<li>name    文件名称</li>
<li>path    文件的相对路径</li>
<li>folder  文件所在的文件夹</li>
<li>contenthash   文件的内容hash，默认是md5生成</li>
<li>hash         文件内容的hash，默认是md5生成</li>
<li>emoji        一个随机的指代文件内容的emoj</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">module<span class="token punctuation">:</span><span class="token punctuation">{</span>     
  rules<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>            
      test<span class="token punctuation">:</span><span class="token regex">/\.(png|svg|jpg|gif)$/</span><span class="token punctuation">,</span>            
      use<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>                
        loader<span class="token punctuation">:</span><span class="token string">'file-loader'</span><span class="token punctuation">,</span>                
        options<span class="token punctuation">:</span><span class="token punctuation">{</span>                    
          name<span class="token punctuation">:</span><span class="token string">'img/[name][hash:8].[ext]'</span>               
        <span class="token punctuation">}</span>            
      <span class="token punctuation">}</span><span class="token punctuation">]</span>        
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>    
<span class="token punctuation">}</span></code></pre>
<h3 id="如何优化-Webpack-的构建速度？"><a href="#如何优化-Webpack-的构建速度？" class="headerlink" title="如何优化 Webpack 的构建速度？"></a>如何优化 Webpack 的构建速度？</h3><ul>
<li><p>使用<code>高版本</code>的 Webpack 和 Node.js</p>
</li>
<li><p><code>多进程/多实例构建</code>：HappyPack(不维护了)、thread-loader</p>
</li>
<li><p><code>压缩代码</code></p>
<ul>
<li>多进程并行压缩<ul>
<li>webpack-paralle-uglify-plugin</li>
<li>uglifyjs-webpack-plugin 开启 parallel 参数 (不支持ES6)</li>
<li>terser-webpack-plugin 开启 parallel 参数</li>
</ul>
</li>
<li>通过 mini-css-extract-plugin 提取 Chunk 中的 CSS 代码到单独文件，通过 css-loader 的 minimize 选项开启 cssnano 压缩 CSS。</li>
</ul>
</li>
<li><p><code>图片压缩</code></p>
<ul>
<li>使用基于 Node 库的 imagemin (很多定制选项、可以处理多种图片格式)</li>
<li>配置 image-webpack-loader</li>
</ul>
</li>
<li><p><code>缩小打包作用域</code>：</p>
<ul>
<li>exclude/include (确定 loader 规则范围)</li>
<li>resolve.modules 指明第三方模块的绝对路径 (减少不必要的查找)</li>
<li>resolve.mainFields 只采用 main 字段作为入口文件描述字段 (减少搜索步骤，需要考虑到所有运行时依赖的第三方模块的入口文件描述字段)</li>
<li>resolve.extensions 尽可能减少后缀尝试的可能性</li>
<li>noParse 对完全不需要解析的库进行忽略 (不去解析但仍会打包到 bundle 中，注意被忽略掉的文件里不应该包含 import、require、define 等模块化语句)</li>
<li>IgnorePlugin (完全排除模块)</li>
<li>合理使用alias</li>
</ul>
</li>
<li><p><code>提取页面公共资源</code>：</p>
<ul>
<li>基础包分离：<ul>
<li>使用 html-webpack-externals-plugin，将基础包通过 CDN 引入，不打入 bundle 中</li>
<li>使用 SplitChunksPlugin 进行(公共脚本、基础包、页面公共文件)分离(Webpack4内置) ，替代了 CommonsChunkPlugin 插件</li>
</ul>
</li>
</ul>
</li>
<li><p><code>DLL</code>：</p>
<ul>
<li>使用 DllPlugin 进行分包，使用 DllReferencePlugin(索引链接) 对 manifest.json 引用，让一些基本不会改动的代码先打包成静态资源，避免反复编译浪费时间。</li>
<li>HashedModuleIdsPlugin 可以解决模块数字id问题</li>
</ul>
</li>
<li><p><code>充分利用缓存提升二次构建速度</code>：</p>
<ul>
<li>babel-loader 开启缓存</li>
<li>terser-webpack-plugin 开启缓存</li>
<li>使用 cache-loader 或者 hard-source-webpack-plugin</li>
</ul>
</li>
<li><p><code>Tree shaking</code></p>
<ul>
<li>打包过程中检测工程中没有引用过的模块并进行标记，在资源压缩时将它们从最终的bundle中去掉(只能对ES6 Modlue生效) 开发中尽可能使用ES6 Module的模块，提高tree shaking效率</li>
<li>禁用 babel-loader 的模块依赖解析，否则 Webpack 接收到的就都是转换过的 CommonJS 形式的模块，无法进行 tree-shaking</li>
<li>使用 PurifyCSS(不在维护) 或者 uncss 去除无用 CSS 代码<ul>
<li>purgecss-webpack-plugin 和 mini-css-extract-plugin配合使用(建议)</li>
</ul>
</li>
</ul>
</li>
<li><p><code>Scope hoisting</code></p>
<ul>
<li>构建后的代码会存在大量闭包，造成体积增大，运行代码时创建的函数作用域变多，内存开销变大。Scope hoisting 将所有模块的代码按照引用顺序放在一个函数作用域里，然后适当的重命名一些变量以防止变量名冲突</li>
<li>必须是ES6的语法，因为有很多第三方库仍采用 CommonJS 语法，为了充分发挥 Scope hoisting 的作用，需要配置 mainFields 对第三方模块优先采用 jsnext:main 中指向的ES6模块化语法</li>
</ul>
</li>
<li><p><code>动态Polyfill</code></p>
<ul>
<li>建议采用 polyfill-service 只给用户返回需要的polyfill，社区维护。 (部分国内奇葩浏览器UA可能无法识别，但可以降级返回所需全部polyfill)</li>
</ul>
</li>
</ul>
<h3 id="Babel原理"><a href="#Babel原理" class="headerlink" title="Babel原理"></a>Babel原理</h3><p>大多数JavaScript Parser遵循 <code>estree</code> 规范，Babel 最初基于 <code>acorn</code> 项目(轻量级现代 JavaScript 解析器)<br>Babel大概分为三大部分：</p>
<ul>
<li>解析：将代码转换成 AST<ul>
<li>词法分析：将代码(字符串)分割为token流，即语法单元成的数组</li>
<li>语法分析：分析token流(上面生成的数组)并生成 AST</li>
</ul>
</li>
<li>转换：访问 AST 的节点进行变换操作生产新的 AST</li>
<li>生成：以新的 AST 为基础生成代码</li>
</ul>
<p>想了解如何一步一步实现一个编译器的同学可以移步 Babel 官网曾经推荐的开源项目<br><a href="https://github.com/jamiebuilds/the-super-tiny-compiler" target="_blank" rel="noopener">the-super-tiny-compiler</a></p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Code/08" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/12/Code/08/"
    >手写Event.EventEmitter</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/12/Code/08/" class="article-date">
  <time datetime="2020-03-12T14:30:00.000Z" itemprop="datePublished">2020-03-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="手写Event-EventEmitter"><a href="#手写Event-EventEmitter" class="headerlink" title="手写Event.EventEmitter"></a>手写Event.EventEmitter</h1><p>一个<strong><em>EventEmitter</em></strong>需要实现以下方法：</p>
<ul>
<li>addEventListener</li>
<li>removeEventlistener</li>
<li>removeAllEventListener</li>
<li>emit</li>
<li>once</li>
</ul>
<h3 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//工具函数</span>
<span class="token keyword">const</span> wrapCallBack <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span>once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> callback<span class="token punctuation">:</span>fn<span class="token punctuation">,</span>once <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h3 id="addEventListener"><a href="#addEventListener" class="headerlink" title="addEventListener"></a>addEventListener</h3><pre class=" language-javascript"><code class="language-javascript">EventEmitter<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>addEventListener <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>fn<span class="token punctuation">,</span>once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//从events获取事件类型为type的事件回调</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// console.log(handler)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果不存在 则添加</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span><span class="token function">wrapCallBack</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span>once<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>handler <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> handler<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果只绑定一个回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span><span class="token punctuation">[</span>handler<span class="token punctuation">,</span><span class="token function">wrapCallBack</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span>once<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//绑定类多个回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">...</span>handler<span class="token punctuation">,</span><span class="token function">wrapCallBack</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span>once<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="removeEventListener"><a href="#removeEventListener" class="headerlink" title="removeEventListener"></a>removeEventListener</h3><pre class=" language-javascript"><code class="language-javascript">EventEmitter<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeListener <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>listener<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//简单比较回调函数是否相同</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">String</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//循环回调函数队列</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> item <span class="token operator">=</span> handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//简单比较回调函数是否相同</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">String</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                handler<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//避免回调函数数组变化 导致数组访问错误</span>
                i<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//如果数组为空 删除监听的事件即可</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">//如果数组只有一个元素 只需要以对象的形式保存即可</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="removeAllEventListener"><a href="#removeAllEventListener" class="headerlink" title="removeAllEventListener"></a>removeAllEventListener</h3><pre class=" language-javascript"><code class="language-javascript">EventEmitter<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeAllListener <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token keyword">return</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="emit"><a href="#emit" class="headerlink" title="emit"></a>emit</h3><pre class=" language-javascript"><code class="language-javascript">EventEmitter<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>emit <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
        eventsArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//如果是回调队列为数组的形式 循环遍历</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//简单实现 避免后续数组长度出现变化 对数组的访问出错</span>
        <span class="token comment" spellcheck="true">//优化：可以考虑写一个工具函数 深拷贝</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventsArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">//遍历type对应的回调队列 触发每一个cb</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> eventsArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> item <span class="token operator">=</span> eventsArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行回调</span>
            item<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>once<span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">//如果回调函数只执行一次 则删除该回调函数</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>item<span class="token punctuation">.</span>callback<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//否则直接执行即可</span>
        handler<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="once"><a href="#once" class="headerlink" title="once"></a>once</h3><pre class=" language-javascript"><code class="language-javascript">EventEmitter<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>once <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>fn<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>fn<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Code/09" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/12/Code/09/"
    >深拷贝 VS 浅拷贝</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/12/Code/09/" class="article-date">
  <time datetime="2020-03-12T02:20:00.000Z" itemprop="datePublished">2020-03-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="深拷贝-VS-浅拷贝"><a href="#深拷贝-VS-浅拷贝" class="headerlink" title="深拷贝 VS 浅拷贝"></a>深拷贝 VS 浅拷贝</h1><blockquote>
<p>深拷贝：拷贝实例。浅拷贝：拷贝引用。</p>
</blockquote>
<p>不知道大家还记不记得高程上对数据类型的定义：<br><strong>基本数据类型：</strong><br>布尔类型、字符串类型、数字类型。这些类型属于基本数据类型，它们的值通常都是直接存放在栈中，所以平时我们在给给变量赋值的时候，就是直接将值直接复制给变量，新变量的更改不会影响原变量。<br><strong>引用类型：</strong><br>对于对象（包含object、array、date、function等等），这些对象的值都存放在堆中，值的引用存放在栈中。</p>
<p>举个🌰：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//10</span>
b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//10,20</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>b<span class="token punctuation">:</span><span class="token number">20</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> obj2 <span class="token operator">=</span> obj1<span class="token punctuation">;</span>
obj2<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//100</span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1583893141137-90d3b97f-a36d-4bfb-a26d-88387fbfad4a.png#align=left&display=inline&height=438&name=image.png&originHeight=1074&originWidth=1468&size=133037&status=done&style=none&width=599" alt="image.png"><br>如图，深拷贝就是在内存中重新开辟一个新的内存，将一个对象从内存中完整的读出来，存放到新的内存中，两者互不影响。</p>
<p>话不多说，先撸为敬。</p>
<h3 id="乞丐版"><a href="#乞丐版" class="headerlink" title="乞丐版"></a>乞丐版</h3><p>在业务场景中，我们使用的最多的就是下面的方式，但是这样的方式存在着潜在的风险，对于一下循环嵌套的对象、数组等，无法进行有效的复制。具体请看<a href="https://www.yuque.com/walter-glskq/zf7grn/uva3mi" target="_blank" rel="noopener">这一篇文章</a></p>
<pre class=" language-javascript"><code class="language-javascript">JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="基础版本（一）"><a href="#基础版本（一）" class="headerlink" title="基础版本（一）"></a>基础版本（一）</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deeClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> element
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">{</span> c<span class="token punctuation">:</span><span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    d<span class="token punctuation">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">deeClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//{ a: 10, b: [ 1, 3, 4, { c: 20 } ], d: true }</span></code></pre>
<h3 id="基础版本（二）"><a href="#基础版本（二）" class="headerlink" title="基础版本（二）"></a>基础版本（二）</h3><p>创建一个新对象，遍历目标对象，将原对象上的属性和属性值一次挂载到新对象上。<br>深拷贝，由于我们不知道原对象会嵌套多少层，所以我们需要使用递归来解决。<br>如果属性值为基本类型，直接将属性和属性值挂载到新对象上。<br>如果属性值为对象类型，则递归遍历该属性的属性值，然后挂载到新对象上。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> element <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            d<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    f<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">{</span> g<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span></code></pre>
<h3 id="基础版本（三）"><a href="#基础版本（三）" class="headerlink" title="基础版本（三）"></a>基础版本（三）</h3><p>兼容循环引用。</p>
<p>我们借用上面的函数，去对一个有循环引用的对象进行深拷贝：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            d<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    f<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">{</span> g<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1583897125036-ba767d71-84e0-4793-828f-badefde0ecf1.png#align=left&display=inline&height=71&name=image.png&originHeight=108&originWidth=822&size=13051&status=done&style=none&width=537" alt="image.png"></p>
<p>如上所示，如果存在对象直接或者间接引用自身的情况，就会出现内存溢出的情况。</p>
<p>为了解决这种情况，我们需要在内存中开辟一个新的空间，来存储当前对象和拷贝对象的关系，当拷贝当前对象的时候，现在存储空间中查找，如果存在，直接返回存储中的值，否则，继续拷贝。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone3</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> element <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
          res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone3</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>
            d<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    f<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">{</span> g<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

obj<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token function">deepClone3</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span></code></pre>
<p>再次执行拷贝：我们可以看到obj.obj值为 <code>Circular</code>，即循环引用的意思。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1583938079008-5972dee1-63ac-4ef4-8cc9-ca65b4978571.png#align=left&display=inline&height=90&name=image.png&originHeight=148&originWidth=670&size=15716&status=done&style=none&width=408" alt="image.png"></p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><p>JavaScript的对象本质上只能是键值对的集合，且键只能为字符串。为了解决这个问题，在ES6中提出了一种新的数据结构：Map。它类似于对象，也是键值对的集合，但是“键”的范围不限于字符串，各种类型的值（包括对象）都可以当作键。也就是说，Object 结构提供了“字符串—值”的对应，Map 结构提供了“值—值”的对应，是一种更完善的 Hash 结构实现。<br>Map的API：</p>
<ol>
<li>size()</li>
<li>set(key,value)</li>
<li>get(key)</li>
<li>has(key)</li>
<li>delete(key)</li>
<li>clear()</li>
</ol>
<p>Map的遍历方法：</p>
<ul>
<li><code>Map.prototype.keys()</code>：返回键名的遍历器。</li>
<li><code>Map.prototype.values()</code>：返回键值的遍历器。</li>
<li><code>Map.prototype.entries()</code>：返回所有成员的遍历器。</li>
<li><code>Map.prototype.forEach()</code>：遍历 Map 的所有成员。</li>
</ul>
<h4 id="WeakMap"><a href="#WeakMap" class="headerlink" title="WeakMap"></a>WeakMap</h4><p>WeakMap是Map的一种变形。但是WeakMap只接受对象作为键（除null外），且WeakMap的键对应的对象，不会被计入垃圾回收机制。<br>使用WeakMap的优势：它的键名所引用的对象都是弱引用，即垃圾回收机制不将该引用考虑在内。因此，只要所引用的对象的其他引用都被清除，垃圾回收机制就会释放该对象所占用的内存。也就是说，一旦不再需要，WeakMap 里面的键名对象和所对应的键值对会自动消失，不用手动删除引用。</p>
<p>总之，<code>WeakMap</code>的专用场合就是，它的键所对应的对象，可能会在将来消失。<code>WeakMap</code>结构有助于防止内存泄漏。<br>WeakMap的API：</p>
<ol>
<li>get(key)</li>
<li>set(key,value)</li>
<li>has(key)</li>
<li>delete(key)</li>
</ol>
<h3 id="兼容其他类型"><a href="#兼容其他类型" class="headerlink" title="兼容其他类型"></a>兼容其他类型</h3><p>每一个对象都有对应的<code>toString()</code>方法，如果该方法未被重写，则调用的就是<code>Object.prototype</code>上的toString()，返回的就是’[object type]’，type就是该对象对应的数据类型。<br>所以，为了防止toString()方法被重写，我们直接调用<code>Object.prototype</code>上的方法，获取数据类型：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//判断类型</span>
<span class="token keyword">function</span> <span class="token function">getType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>前面提到过，对应可引用的数据类型，我们要递归遍历；对应不可引用的数据类型，直接复制即可：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//判断是否是可引用的数据类型 </span>
<span class="token keyword">function</span> <span class="token function">isRefrenceType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> target<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>这里大致对一些数据类型进行划分：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//引用类型</span>
<span class="token keyword">const</span> mapTag <span class="token operator">=</span> <span class="token string">'Map'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> setTag <span class="token operator">=</span> <span class="token string">'Set'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> arrayTag <span class="token operator">=</span> <span class="token string">'Array'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objectTag <span class="token operator">=</span> <span class="token string">'Object'</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">//不可引用类型</span>
<span class="token keyword">const</span> boolTag <span class="token operator">=</span> <span class="token string">'Boolean'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dateTag <span class="token operator">=</span> <span class="token string">'Date'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> errorTag <span class="token operator">=</span> <span class="token string">'Error'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> numberTag <span class="token operator">=</span> <span class="token string">'Number'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> regexpTag <span class="token operator">=</span> <span class="token string">'RegExp'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stringTag <span class="token operator">=</span> <span class="token string">'String'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> symbolTag <span class="token operator">=</span> <span class="token string">'Symbol'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bufferTag <span class="token operator">=</span> <span class="token string">'Uint8Array'</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//判断类型</span>
<span class="token keyword">function</span> <span class="token function">getType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//判断是否是原始类型类型 </span>
<span class="token keyword">function</span> <span class="token function">isRefrenceType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> target<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//获取原型上的方法</span>
<span class="token keyword">function</span> <span class="token function">getInit</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ClassNames <span class="token operator">=</span> target<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClassNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//引用类型</span>
<span class="token keyword">const</span> mapTag <span class="token operator">=</span> <span class="token string">'Map'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> setTag <span class="token operator">=</span> <span class="token string">'Set'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> arrayTag <span class="token operator">=</span> <span class="token string">'Array'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objectTag <span class="token operator">=</span> <span class="token string">'Object'</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">//不可引用类型</span>
<span class="token keyword">const</span> boolTag <span class="token operator">=</span> <span class="token string">'Boolean'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dateTag <span class="token operator">=</span> <span class="token string">'Date'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> errorTag <span class="token operator">=</span> <span class="token string">'Error'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> numberTag <span class="token operator">=</span> <span class="token string">'Number'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> regexpTag <span class="token operator">=</span> <span class="token string">'RegExp'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stringTag <span class="token operator">=</span> <span class="token string">'String'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> symbolTag <span class="token operator">=</span> <span class="token string">'Symbol'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bufferTag <span class="token operator">=</span> <span class="token string">'Uint8Array'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> deepTag <span class="token operator">=</span> <span class="token punctuation">[</span>mapTag<span class="token punctuation">,</span> setTag<span class="token punctuation">,</span> arrayTag<span class="token punctuation">,</span> objectTag<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">deepClone4</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token function">getType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isOriginType <span class="token operator">=</span> <span class="token function">isRefrenceType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isOriginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deepTag<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cloneTarget <span class="token operator">=</span> <span class="token function">getInit</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//防止循环引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> cloneTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//如果是mapTag 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> mapTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> cloneTarget<span class="token punctuation">,</span> <span class="token string">'target'</span><span class="token punctuation">)</span>
        target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            cloneTarget<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">deepClone4</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//如果是setTag 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> setTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            cloneTarget<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">deepClone4</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//如果是arrayTag 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> arrayTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            cloneTarget<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone4</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> map<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//objectTag 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> objectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> array <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            cloneTarget<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone4</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'kaka'</span><span class="token punctuation">)</span>



<span class="token keyword">const</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
    field1<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    field2<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    field3<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">:</span> <span class="token string">'child'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    field4<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    empty<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    map<span class="token punctuation">,</span>
    <span class="token keyword">set</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
target<span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
<span class="token keyword">const</span> target1 <span class="token operator">=</span> <span class="token function">deepClone4</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
target1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">"a"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🍎'</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🍌'</span><span class="token punctuation">,</span> target1<span class="token punctuation">)</span></code></pre>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Interview/04" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/12/Interview/04/"
    >web常见的攻击手段</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/12/Interview/04/" class="article-date">
  <time datetime="2020-03-12T02:20:00.000Z" itemprop="datePublished">2020-03-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="常见的攻击手段"><a href="#常见的攻击手段" class="headerlink" title="常见的攻击手段"></a>常见的攻击手段</h1><h3 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h3><p>DOS(Denial Service)拒绝服务式攻击，它是一种实现即简单很有效的针对服务器进行的攻 击方式，它的攻击目的就是让被攻击的主机和服务器拒绝用户正常访问，破坏系统正常运行 ，从而达到互联网用户无法连接被攻击的服务器和主机，造成服务器瘫痪。它的攻击过程，首先攻击者向被攻击的服务器发生大量带有虚假IP地址的服务请求，被攻击者在接收到请求 后返回确认信息，等待攻击者确认，此过程需要TCP的三次交换。由于攻击者发送的请求信 息是虚假的，所以被攻击服务器无法接受到信息确认，一直处于等待状态，而分配给这次请 求的资源却始终没有被释放。当被攻击者等待一定的时间后，连接会因超时而被断开，这是 攻击者再次发送新的虚假信息请求，就这样最终服务器资源被耗尽，直到瘫痪。</p>
<h3 id="DDOS"><a href="#DDOS" class="headerlink" title="DDOS"></a>DDOS</h3><p>DDOS(Distributed Denial Service)分布拒绝式攻击，它是在DOS基础上进行的大规模，大 范围的攻击模式，DOS只是单机和单机之间的攻击模式，而DDOS是利用一批受控制的僵尸主 机向一台服务器主机发起的攻击，其攻击的强度和造成的威胁要比DOS严重很多，更具破坏 性。首先DDOS攻击者要寻找僵尸主机，在互联网上寻找一些有后门漏洞的主机，然后入侵系 统安装控制程序，入侵的越多，控制的僵尸主机就越多，攻击源就更多，然后把入侵的主机 分配，一部分充当攻击的主要控制端，一部分充当攻击源，各负其责，在攻击者统一指挥下 对被攻击的服务器发起攻击，由于这个攻击模式是在幕后操作，所以很难被监控系统跟踪， 身份不容易被发现。</p>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><p>XSS(Cross Site Scripting)，跨站脚本攻击。指的是通过网页开发过程中留下的漏洞，通过一些方法将恶意指令代码注入到网页中，使用户加载并执行攻击者的恶意程序指令。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java、 VBScript、ActiveX、 Flash 或者甚至是普通的HTML。攻击成功后，攻击者可能得到包括但不限于更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。</p>
<h4 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h4><p>攻击者的恶意代码并没有注入到网站中，而是诱使用户点击目标网站的链接来实施攻击。<br>反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。<br>反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。</p>
<h4 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h4><p>攻击者的恶意代码被保存到目标网站的服务器中，这种攻击的持久性和稳定性较强。</p>
<h4 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h4><p>DOM型指的就是攻击者输入恶意的代码前端没有做任何过滤被执行了，然后恶意代码发送到攻击者的网站，模拟用户的行为。</p>
<ol>
<li>攻击者构造出特殊的 URL，其中包含恶意代码。</li>
<li>用户打开带有恶意代码的 URL。</li>
<li>用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。</li>
<li>恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作</li>
</ol>
<h4 id="反射型XSS和存储型XSS防范"><a href="#反射型XSS和存储型XSS防范" class="headerlink" title="反射型XSS和存储型XSS防范"></a>反射型XSS和存储型XSS防范</h4><p>存储型和反射型 XSS 都是在服务端取出恶意代码后，插入到响应 HTML 里的，攻击者刻意编写的“数据”被内嵌到“代码”中，被浏览器所执行。<br>预防这两种漏洞，有两种常见做法：</p>
<ul>
<li>改成纯前端渲染，把代码和数据分隔开。</li>
<li>对 HTML 做充分转义。</li>
</ul>
<h4 id="DOM型XSS防范"><a href="#DOM型XSS防范" class="headerlink" title="DOM型XSS防范"></a>DOM型XSS防范</h4><p>DOM 型 XSS 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。<br>在使用 <code>.innerHTML</code>、<code>.outerHTML</code>、<code>document.write()</code> 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 <code>.textContent</code>、<code>.setAttribute()</code> 等。<br>如果用 Vue/React 技术栈，并且不使用 <code>v-html</code>/<code>dangerouslySetInnerHTML</code> 功能，就在前端 render 阶段避免 <code>innerHTML</code>、<code>outerHTML</code> 的 XSS 隐患。<br>DOM 中的内联事件监听器，如 <code>location</code>、<code>onclick</code>、<code>onerror</code>、<code>onload</code>、<code>onmouseover</code> 等，<code>&lt;a&gt;</code> 标签的 <code>href</code> 属性，JavaScript 的 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code> 等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。</p>
<h4 id="常见的XSS注入方法"><a href="#常见的XSS注入方法" class="headerlink" title="常见的XSS注入方法"></a>常见的XSS注入方法</h4><ul>
<li>在 HTML 中内嵌的文本中，恶意内容以 script 标签形成注入。</li>
<li>在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。</li>
<li>在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。</li>
<li>在标签的 href、src 等属性中，包含 <code>javascript:</code> 等可执行代码。</li>
<li>在 onload、onerror、onclick 等事件中，注入不受控制代码。</li>
<li>在 style 属性和标签中，包含类似 <code>background-image:url(&quot;javascript:...&quot;);</code> 的代码（新版本浏览器已经可以防范）。</li>
<li>在 style 属性和标签中，包含类似 <code>expression(...)</code> 的 CSS 表达式代码（新版本浏览器已经可以防范）</li>
</ul>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Interview/05" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/11/Interview/05/"
    >vue常见面试题</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/11/Interview/05/" class="article-date">
  <time datetime="2020-03-11T02:20:00.000Z" itemprop="datePublished">2020-03-11</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="vue常见面试题"><a href="#vue常见面试题" class="headerlink" title="vue常见面试题"></a>vue常见面试题</h1><h3 id="1、你知道vue的模板语法用的是哪个web模板引擎的吗？说说你对这模板引擎的理解。"><a href="#1、你知道vue的模板语法用的是哪个web模板引擎的吗？说说你对这模板引擎的理解。" class="headerlink" title="1、你知道vue的模板语法用的是哪个web模板引擎的吗？说说你对这模板引擎的理解。"></a>1、你知道vue的模板语法用的是哪个web模板引擎的吗？说说你对这模板引擎的理解。</h3><p>使用的Mustache模版。<br>模板引擎：<br>负责组装数据，以另外一种形式或外观展现数据。<br>优点：</p>
<ol>
<li>可维护性（后期改起来方便）；</li>
<li>可扩展性（想要增加功能，增加需求方便）；</li>
<li>开发效率提高（程序逻辑组织更好，调试方便）；</li>
<li>看起来舒服（不容易写错）</li>
</ol>
<h3 id="2、你知道v-model的原理吗？"><a href="#2、你知道v-model的原理吗？" class="headerlink" title="2、你知道v-model的原理吗？"></a>2、你知道v-model的原理吗？</h3><p>v-model只是一个语法糖，其内部实现原理就是使用<code>v-bind</code>和<code>input</code>事件监听值的改变。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token function">changeValue</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    value <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
<span class="token punctuation">}</span></code></pre>
<h3 id="3、使用过vue开发过多语言项目吗？说说你的做法"><a href="#3、使用过vue开发过多语言项目吗？说说你的做法" class="headerlink" title="3、使用过vue开发过多语言项目吗？说说你的做法"></a>3、使用过vue开发过多语言项目吗？说说你的做法</h3><p>使用vue-i18n。具体使用请参考<a href="https://kazupon.github.io/vue-i18n/zh/started.html#html" target="_blank" rel="noopener">vue-i18n</a>。</p>
<ol>
<li>安装：npm install vue-i18n –save-dev</li>
<li>创建语言文件：language-zh.js和language-en.js   分别对应中文和英文。</li>
<li>在main.js中引入。</li>
<li>切换语言。</li>
</ol>
<p>language-zh.js:</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> lang <span class="token operator">=</span> <span class="token punctuation">{</span>
    home<span class="token punctuation">:</span>'首页‘<span class="token punctuation">,</span>
  name<span class="token punctuation">:</span><span class="token string">'姓名'</span>
<span class="token punctuation">}</span></code></pre>
<p>language-en.js:</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> lang <span class="token operator">=</span> <span class="token punctuation">{</span>
    home<span class="token punctuation">:</span>'home‘<span class="token punctuation">,</span>
  name<span class="token punctuation">:</span><span class="token string">'name'</span>
<span class="token punctuation">}</span></code></pre>
<p>main.js：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> VueI18n <span class="token keyword">from</span> <span class="token string">'vue-i18n'</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueI18n<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通过插件的形式挂载，通过全局方法 Vue.use() 使用插件const i18n = new VueI18n({</span>
  locale<span class="token punctuation">:</span> <span class="token string">'zh'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 语言标识 //this.$i18n.locale // 通过切换locale的值来实现语言切换</span>
  messages<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'zh'</span><span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./VueI18n/language-zh'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
    <span class="token string">'en'</span><span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./VueI18n/language-en'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  router<span class="token punctuation">,</span>
  i18n<span class="token punctuation">,</span>
  components<span class="token punctuation">:</span> <span class="token punctuation">{</span> App <span class="token punctuation">}</span><span class="token punctuation">,</span>
  template<span class="token punctuation">:</span> <span class="token string">'&lt;App/>'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>切换语言：</p>
<pre class=" language-javascript"><code class="language-javascript">changeLaguages <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$i18n<span class="token punctuation">.</span>locale<span class="token punctuation">)</span>
  <span class="token keyword">let</span> lang <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$i18n<span class="token punctuation">.</span>locale <span class="token operator">===</span> <span class="token string">'zh'</span> <span class="token operator">?</span> <span class="token string">'en'</span> <span class="token punctuation">:</span> <span class="token string">'zh'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$i18n<span class="token punctuation">.</span>locale <span class="token operator">=</span> lang
<span class="token punctuation">}</span></code></pre>
<h3 id="4、在使用计算属性时，函数名可以和data数据源中的属性同名吗？为什么？"><a href="#4、在使用计算属性时，函数名可以和data数据源中的属性同名吗？为什么？" class="headerlink" title="4、在使用计算属性时，函数名可以和data数据源中的属性同名吗？为什么？"></a>4、在使用计算属性时，函数名可以和data数据源中的属性同名吗？为什么？</h3><p>不可以。因为无论是计算属性、data、还是props，最终都会挂载到vm实例上，因此三者不可以同名。<br>在<code>src/core/instance/state.js#L202</code>这里，会做一个检查。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585211440320-e5bd3457-7dfa-4292-a2d2-46854c33ce62.png#align=left&display=inline&height=126&name=image.png&originHeight=236&originWidth=1220&size=43368&status=done&style=none&width=650" alt="image.png"><br>而且在初始化vm的时候，会依次初始化props、mehtods、data，computed等。这是初始化的源码：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5、vue中data数据源中的属性可以和methods中的方法名重名吗？为什么？"><a href="#5、vue中data数据源中的属性可以和methods中的方法名重名吗？为什么？" class="headerlink" title="5、vue中data数据源中的属性可以和methods中的方法名重名吗？为什么？"></a>5、vue中data数据源中的属性可以和methods中的方法名重名吗？为什么？</h3><p>不可以。<br>在初始化data的时候，程序会进行检查，<code>src/core/instance/state.js#L113</code>，在<code>initState</code>函数：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> initData <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token string">'data functions should return an object:\n'</span> <span class="token operator">+</span>
      <span class="token string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span><span class="token punctuation">,</span>
      vm
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// proxy data on instance</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//这里会对同名属性和方法进行警告</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token string">`Method "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" has already been defined as a data property.`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//这里会对同名的props和属性进行警告</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token string">`The data property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already declared as a prop. `</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token string">`Use prop default value instead.`</span></span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_data`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// observe data</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5、怎么给vue定义全局方法？"><a href="#5、怎么给vue定义全局方法？" class="headerlink" title="5、怎么给vue定义全局方法？"></a>5、怎么给vue定义全局方法？</h3><ol>
<li>挂载到Vue的原型上，即：Vue.prototype.methodsName = function(){}。</li>
<li>使用mixin，即Vue.use(mixins)。</li>
</ol>
<h3 id="6、vue2-0中不再支持在v-html中使用过滤器了怎么办？"><a href="#6、vue2-0中不再支持在v-html中使用过滤器了怎么办？" class="headerlink" title="6、vue2.0中不再支持在v-html中使用过滤器了怎么办？"></a>6、vue2.0中不再支持在v-html中使用过滤器了怎么办？</h3><ol>
<li>使用全局方法。推荐</li>
<li>使用filters过滤器。</li>
<li>使用computed。</li>
<li>使用methods。</li>
</ol>
<p>全局方法：</p>
<pre class=" language-javascript"><code class="language-javascript">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token keyword">function</span>（msg）<span class="token punctuation">{</span> 
　<span class="token keyword">return</span> msg<span class="token punctuation">.</span>replace（<span class="token string">"\n"</span>，<span class="token string">"&lt;br>"</span>）
<span class="token punctuation">}</span>；</code></pre>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>msg(content)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<p>filters过滤器：</p>
<pre class=" language-javascript"><code class="language-javascript">filters：<span class="token punctuation">{</span>
  msg：<span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span>\n<span class="token operator">/</span>g，<span class="token string">"&lt;br>"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>computed：</p>
<pre class=" language-javascript"><code class="language-javascript">computed<span class="token punctuation">:</span><span class="token punctuation">{</span>
  msg：<span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span>\n<span class="token operator">/</span>g，<span class="token string">"&lt;br>"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>mehtods：</p>
<pre class=" language-javascript"><code class="language-javascript">methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
  msg：<span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span>\n<span class="token operator">/</span>g，<span class="token string">"&lt;br>"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="7、使用vue后怎么针对搜索引擎做SEO优化"><a href="#7、使用vue后怎么针对搜索引擎做SEO优化" class="headerlink" title="7、使用vue后怎么针对搜索引擎做SEO优化?"></a>7、使用vue后怎么针对搜索引擎做SEO优化?</h3><ol>
<li>SSR服务端渲染</li>
<li>NUXT同构</li>
<li>prerender-spa-plugin 预渲染</li>
</ol>
<h3 id="8、和keep-alive相关的生命周期有哪些？描述下这些生命周期"><a href="#8、和keep-alive相关的生命周期有哪些？描述下这些生命周期" class="headerlink" title="8、和keep-alive相关的生命周期有哪些？描述下这些生命周期"></a>8、和keep-alive相关的生命周期有哪些？描述下这些生命周期</h3><p>activated 和 deactivated。</p>
<ol>
<li>activated：当页面进入的时候，依次触发：created –&gt; mounted –&gt; activated。</li>
<li>deactivated：当退出页面的时候触发deactivated，当在此前进或者后退的时候之后触发activated。</li>
</ol>
<h3 id="9、你知道vue中key的原理吗？"><a href="#9、你知道vue中key的原理吗？" class="headerlink" title="9、你知道vue中key的原理吗？"></a>9、你知道vue中key的原理吗？</h3><blockquote>
<p>src\core\vdom\patch.js - updateChildren()</p>
</blockquote>
<p>1、key的作用主要是为了高效的更新虚拟DOM，其原理是vue在patch过程中通过key可以精准判断两个节点是否是同一个，从而避免频繁更新不同元素，使得整个patch过程更加高效，减少DOM操作量，提高性能。<br>2、同时，在vue中使用相同标签名的元素过渡的时候需要使用key进行区分，否则vue之后更新其内部属性而不会触发过渡效果。</p>
<h3 id="10、-vue如何重置data？"><a href="#10、-vue如何重置data？" class="headerlink" title="10、 vue如何重置data？"></a>10、 vue如何重置data？</h3><p>this.$data: 获取当前状态下的data。<br>this.$options.data()：获取当前组件初始化状态下的data。<br>so：Object.assgin( this.$data,this.$options.data() )</p>
<h3 id="11、谈谈你对mvc-、mvp和mvvm的理解？"><a href="#11、谈谈你对mvc-、mvp和mvvm的理解？" class="headerlink" title="11、谈谈你对mvc 、mvp和mvvm的理解？"></a>11、谈谈你对mvc 、mvp和mvvm的理解？</h3><p>在web1.0时代，并没有web前端的概念，当时开发一个web应用基本是由asp、.net、java等后台人员完成。项目通常包含html、css、js等文件。这样做的优势就是开发简单快捷。缺点就是jsp文件难以维护。</p>
<ul>
<li>mvc：为了解决上述问题，使前后端职责更加清晰、代码更容易维护、于是mvc开发模式和框架应运而生。在这个模式下，前端主要负责v，即视图层view，前端使用html模版渲染html。后台负责c层和m层，即控制层和数据层。当用户发起请求时，后端根据用户请求路径，返回相应的页面。这样的缺点就是前端页面开发效率不高、前后端职责还不够清晰明确。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1584351722739-4e8c350b-c471-4eaf-ba23-d51c7634b0ab.png#align=left&display=inline&height=437&name=image.png&originHeight=403&originWidth=540&size=35463&status=done&style=none&width=586" alt="image.png"><br>在web2.0时代，随着ajax的出现，让前端可以使用ajax和后台进行交互，前后端职责更加清晰。于是浏览器和服务器之间的整体架构变成了这样：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1584351877474-3ebda797-8857-40b4-9acd-487b717db3ae.png#align=left&display=inline&height=447&name=image.png&originHeight=389&originWidth=532&size=34544&status=done&style=none&width=612" alt="image.png"></p>
<p>页面通过ajax与服务器进行交互，前端人员只负责页面不分，数据部分由后台获取。而且使用ajax可以局部刷新页面，大大降低了服务端压力和流量消耗，而且对用户端体验也更加友好。</p>
<ul>
<li>mvp：随着业务的增加，我们对项目的不断跌倒，就会导致view层越来越庞大，controller层显得越发单薄。于是人们就这v层和m层中间添加了p层。由p层负责m层和v层之间的数据流动，防止二者直接进行数据流动。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1584352260033-31612d02-6a81-42bc-ac51-4342dd24056a.png#align=left&display=inline&height=173&name=image.png&originHeight=118&originWidth=450&size=23031&status=done&style=none&width=658" alt="image.png"></p>
<p>我们可以通过看到，presenter负责和Model进行双向交互，还和View进行双向交互。这种交互方式，相对于MVC来说少了一些灵活，VIew变成了被动视图，并且本身变得很小。虽然它分离了View和Model。但是应用逐渐变大之后，导致presenter的体积增大，难以维护。</p>
<ul>
<li>mvvm：首先，何为MVVM呢？MVVM可以分解成(Model-View-VIewModel)。ViewModel可以理解为在presenter基础上的进阶版。如图所示：</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1584352345351-4218f74c-f782-45c1-b8d7-78a1fbc5a96c.png#align=left&display=inline&height=261&name=image.png&originHeight=319&originWidth=643&size=79362&status=done&style=none&width=527" alt="image.png"></p>
<p>ViewModel通过实现一套数据响应式机制自动响应Model中数据变化；<br>同时Viewmodel会实现一套更新策略自动将数据变化转换为视图更新；<br>通过事件监听响应View中用户交互修改Model中数据。<br>这样在ViewModel中就减少了大量DOM操作代码。<br>MVVM在保持View和Model松耦合的同时，还减少了维护它们关系的代码，使用户专注于业务逻辑，兼顾开发效率和可维护性。</p>
<p>总结：</p>
<ul>
<li>这三者都是框架模式，它们设计的目标都是为了解决Model和View的耦合问题。</li>
<li>MVC模式出现较早主要应用在后端，如Spring MVC、ASP.NET MVC等，在前端领域的早期也有应用，如Backbone.js。它的优点是分层清晰，缺点是数据流混乱，灵活性带来的维护性问题。</li>
<li>MVP模式在是MVC的进化形式，Presenter作为中间层负责MV通信，解决了两者耦合问题，但P层过于臃肿会导致维护问题。</li>
<li>MVVM模式在前端领域有广泛应用，它不仅解决MV耦合问题，还同时解决了维护两者映射关系的大量繁杂代码和DOM操作代码，在提高开发效率、可读性同时还保持了优越的性能表现。</li>
</ul>
<h3 id="12、你知道style加scope属性的原理和作用吗"><a href="#12、你知道style加scope属性的原理和作用吗" class="headerlink" title="12、你知道style加scope属性的原理和作用吗"></a>12、你知道style加scope属性的原理和作用吗</h3><p>用途：防止全局同名CSS污染<br>原理：在标签加上v-data-something属性，再在选择器时加上对应[v-data-something]，即CSS带属性选择器，以此完成类似作用域的选择方式。</p>
<h3 id="13、vue边界情况有哪些"><a href="#13、vue边界情况有哪些" class="headerlink" title="13、vue边界情况有哪些"></a>13、vue边界情况有哪些</h3><ol>
<li>访问根实例：this.$root </li>
<li>访问父组件：this.$parent</li>
<li>访问子组件：this.$refs</li>
<li>依赖注入：provide inject</li>
<li>组件递归引用</li>
</ol>
<h3 id="14、子组件如何访问父组件"><a href="#14、子组件如何访问父组件" class="headerlink" title="14、子组件如何访问父组件"></a>14、子组件如何访问父组件</h3><ol>
<li>直接在子组件中使用this.$parent.methods</li>
<li>子组件使用$emit发送一个事件，在父组件中设置监听</li>
<li>父组件将事件通过属性传递给子组件</li>
</ol>
<h3 id="15、watch-methods中使用箭头函数会怎么样？"><a href="#15、watch-methods中使用箭头函数会怎么样？" class="headerlink" title="15、watch/methods中使用箭头函数会怎么样？"></a>15、watch/methods中使用箭头函数会怎么样？</h3><p>不能使用箭头函数。因为箭头函数的this默认绑定父级作用域，而不是vue实例。如果使用的是npm安装的vue，则此时this指向当前组件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/705088/1585276525133-0ed18bfa-6f6c-4496-ab17-d5474f0f514e.png#align=left&display=inline&height=351&name=image.png&originHeight=702&originWidth=1740&size=154056&status=done&style=none&width=870" alt="image.png"><br>如果使用的是script标签，则this指向window。</p>
<h3 id="16-、vue如何配置favicon"><a href="#16-、vue如何配置favicon" class="headerlink" title="16 、vue如何配置favicon"></a>16 、vue如何配置favicon</h3><ul>
<li>在插件配置中的HtmlWebpackPlugin中配置</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token string">'src/index.html'</span><span class="token punctuation">,</span>
  favicon<span class="token punctuation">:</span><span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>在html模版中配置：</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"icon"</span> href<span class="token operator">=</span><span class="token string">"/assets/title.png"</span> type<span class="token operator">=</span><span class="token string">"image/x-icon"</span> <span class="token operator">/</span><span class="token operator">></span></code></pre>
<h3 id="17、vue的错误处理你知道多少？"><a href="#17、vue的错误处理你知道多少？" class="headerlink" title="17、vue的错误处理你知道多少？"></a>17、vue的错误处理你知道多少？</h3><ul>
<li>errorHandler</li>
</ul>
<p>具体请看：<a href="https://vuejs.org/v2/api/#errorHandler" target="_blank" rel="noopener">errorHandler</a></p>
<pre class=" language-javascript"><code class="language-javascript">Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// handle error</span>
  <span class="token comment" spellcheck="true">// `info` is a Vue-specific error info, e.g. which lifecycle hook</span>
  <span class="token comment" spellcheck="true">// the error was found in. Only available in 2.2.0+</span>
<span class="token punctuation">}</span></code></pre>
<p>其中：<code>err</code>指的是<code>error</code>对象本身，info指的是错误信息，vm指的是vue实例。</p>
<ul>
<li>warnHandler</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>warnHandler <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> trace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// `trace` is the component hierarchy trace</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Warn: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\nTrace: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>trace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>trace代表组件树。<br>例如：我们引入一个不存在的变量</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span> v<span class="token operator">-</span>cloak<span class="token operator">></span>
  Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></code></pre>
<p>就会提示：</p>
<pre class=" language-javascript"><code class="language-javascript">Warn<span class="token punctuation">:</span> Property or method <span class="token string">'name'</span> is not defined on the instance but referenced during render<span class="token punctuation">.</span> Make sure that <span class="token keyword">this</span> property is reactive<span class="token punctuation">,</span> either <span class="token keyword">in</span> the data option<span class="token punctuation">,</span> or <span class="token keyword">for</span> <span class="token keyword">class</span><span class="token operator">-</span>based components<span class="token punctuation">,</span> by initializing the property<span class="token punctuation">.</span> See<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>vuejs<span class="token punctuation">.</span>org<span class="token operator">/</span>v2<span class="token operator">/</span>guide<span class="token operator">/</span>reactivity<span class="token punctuation">.</span>html#Declaring<span class="token operator">-</span>Reactive<span class="token operator">-</span>Properties<span class="token punctuation">.</span>
Trace<span class="token punctuation">:</span> 

<span class="token punctuation">(</span>found <span class="token keyword">in</span> <span class="token operator">&lt;</span>Root<span class="token operator">></span><span class="token punctuation">)</span></code></pre>
<ul>
<li>renderError：和前面两个不同，这个技巧不适用于全局，和组件相关。并且只适用于非生产环境。</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
  renderError <span class="token punctuation">(</span>h<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token punctuation">:</span> <span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>举个栗子：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span> v<span class="token operator">-</span>cloak<span class="token operator">></span>
  Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>name2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
  computed<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token function">name2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<pre class=" language-javascript"><code class="language-javascript">ReferenceError<span class="token punctuation">:</span> x is not defined
    at Vue<span class="token punctuation">.</span>name2 <span class="token punctuation">(</span>pen<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">45</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>
    at Watcher<span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4478</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">)</span>
    at Watcher<span class="token punctuation">.</span>evaluate <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4583</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">)</span>
    at Proxy<span class="token punctuation">.</span>computedGetter <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4832</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">)</span>
    at Proxy<span class="token punctuation">.</span>eval <span class="token punctuation">(</span>eval at createFunction <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">11649</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>anonymous<span class="token operator">></span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">68</span><span class="token punctuation">)</span>
    at Vue<span class="token punctuation">.</span>_render <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">3551</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">)</span>
    at Vue<span class="token punctuation">.</span>updateComponent <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4067</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">)</span>
    at Watcher<span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4478</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">)</span>
    at <span class="token keyword">new</span> <span class="token class-name">Watcher</span> <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4467</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">)</span>
    at mountComponent <span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com<span class="token operator">/</span>vue@<span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">/</span>dist<span class="token operator">/</span>vue<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">4074</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>errorCaptured</li>
</ul>
<p><strong>类型</strong>：<code>(err: Error, vm: Component, info: string) =&gt; ?boolean</code><br>当捕获一个来自子孙组件的错误时被调用。此钩子会收到三个参数：错误对象、发生错误的组件实例以及一个包含错误来源信息的字符串。此钩子可以返回 <code>false</code> 以阻止该错误继续向上传播。</p>
<h3 id="18、vue文件中style、script是必须的吗"><a href="#18、vue文件中style、script是必须的吗" class="headerlink" title="18、vue文件中style、script是必须的吗"></a>18、vue文件中style、script是必须的吗</h3><p>style不是必须的。但是script是必须的：<code>export default {}</code></p>
<h3 id="19、如果vue变量名出现以-或者-开头的时候，会出现什么情况？"><a href="#19、如果vue变量名出现以-或者-开头的时候，会出现什么情况？" class="headerlink" title="19、如果vue变量名出现以_或者$开头的时候，会出现什么情况？"></a>19、如果vue变量名出现以_或者$开头的时候，会出现什么情况？</h3><p>会报<code>undefined</code>。因为在<code>initState</code>的时候，<code>vm</code>会代理所有的<code>data</code>，如果出现有<code>_</code>或者<code>$</code>开头的变量名，可能会和<code>vm</code>内部属性冲突，<code>vue</code>不会代理该属性。可以通过<code>vm.$data.</code>访问。</p>
<h3 id="20、vue使用v-for遍历对象的时候，是按什么顺序遍历的？如何保证遍历顺序？"><a href="#20、vue使用v-for遍历对象的时候，是按什么顺序遍历的？如何保证遍历顺序？" class="headerlink" title="20、vue使用v-for遍历对象的时候，是按什么顺序遍历的？如何保证遍历顺序？"></a>20、vue使用v-for遍历对象的时候，是按什么顺序遍历的？如何保证遍历顺序？</h3><p>首先，会判断对象是否有<code>iterator</code>接口，如果有，则循环执行<code>next()</code>方法。<br>没有<code>iterator</code>接口的情况下，使用<code>Object.keys()</code>遍历，但是在不同浏览器的情况下，遍历的结果不可能完全一致。<br>可以将对象放在数组中，遍历数组可以保证遍历顺序。</p>
<h3 id="21、vue想扩展组件时该怎么做？"><a href="#21、vue想扩展组件时该怎么做？" class="headerlink" title="21、vue想扩展组件时该怎么做？"></a>21、vue想扩展组件时该怎么做？</h3><ul>
<li>Vue.mixin混入</li>
<li>Vue.extend</li>
<li>solt</li>
</ul>
<h3 id="22、vue中-attrs-和-listeners的使用场景"><a href="#22、vue中-attrs-和-listeners的使用场景" class="headerlink" title="22、vue中$attrs 和 $listeners的使用场景"></a>22、vue中$attrs 和 $listeners的使用场景</h3><p>组件传值的时候会用到 爷爷在父亲组件传递值，父亲组件会通过$attrs获取到不在父亲props里面的所有属性，父亲组件通过在孙子组件上绑定$attrs 和 $listeners 使孙组件获取爷爷传递的值并且可以调用在爷爷那里定义的方法<br>A组件：爷爷级组件</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>
  <span class="token operator">&lt;</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>B <span class="token punctuation">:</span>a<span class="token operator">=</span><span class="token string">"a"</span> <span class="token punctuation">:</span>b<span class="token operator">=</span><span class="token string">"b"</span> <span class="token punctuation">:</span>c<span class="token operator">=</span><span class="token string">"c"</span> v<span class="token operator">-</span>bind<span class="token operator">=</span><span class="token string">"$attrs"</span> @test<span class="token operator">=</span><span class="token string">"test"</span> @test2<span class="token operator">=</span><span class="token string">"test2"</span> v<span class="token operator">-</span>on<span class="token operator">=</span><span class="token string">"$listeners"</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">import</span> B <span class="token keyword">from</span> <span class="token string">'./B.vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span><span class="token punctuation">{</span>
        B
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>
            b<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>
            c<span class="token punctuation">:</span><span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p>B组件：父亲级组件</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>
  <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>p<span class="token operator">></span>attrs<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $attrs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&lt;</span>p style<span class="token operator">=</span><span class="token string">"background:#ccc;"</span>  @click<span class="token operator">=</span><span class="token string">"$listeners.test"</span><span class="token operator">></span>props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> a <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&lt;</span>C v<span class="token operator">-</span>bind<span class="token operator">=</span><span class="token string">"$attrs"</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">import</span> C <span class="token keyword">from</span> <span class="token string">'./C.vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    components<span class="token punctuation">:</span><span class="token punctuation">{</span>
        C
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span><span class="token string">"B"</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p>C：孙子级组件</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>
  <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>p<span class="token operator">></span>C <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>$attrs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">"C"</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    inheritAttrs<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<h3 id="23、vue为什么要求组件模版只能有一个根结点"><a href="#23、vue为什么要求组件模版只能有一个根结点" class="headerlink" title="23、vue为什么要求组件模版只能有一个根结点"></a>23、vue为什么要求组件模版只能有一个根结点</h3><p>因为vue组件最终是要被各种loader打包解析的，而我们必须为loader指定一个入口。而且，模版最终是会被编译成vdom的，所以必须有一个根结点来递归遍历其子节点，渲染成一个“树”。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Code/06" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/03/05/Code/06/"
    >柯里化</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/05/Code/06/" class="article-date">
  <time datetime="2020-03-05T14:30:00.000Z" itemprop="datePublished">2020-03-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="柯里化"><a href="#柯里化" class="headerlink" title="柯里化"></a>柯里化</h1><h3 id="柯里化-1"><a href="#柯里化-1" class="headerlink" title="柯里化"></a>柯里化</h3><h4 id="什么是函数柯里化？"><a href="#什么是函数柯里化？" class="headerlink" title="什么是函数柯里化？"></a>什么是函数柯里化？</h4><p>函数柯里化就是使函数先接受一部分参数，使用闭包缓存已接受的函数，返回一个新的函数，在新的函数中接受剩余参数。常常用作实现参数复用、尽量使代码函数化，增加可读性。</p>
<h4 id="实现函数柯里化"><a href="#实现函数柯里化" class="headerlink" title="实现函数柯里化"></a>实现函数柯里化</h4><p>先给一个常见的面试题：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//1</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//3</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//6</span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/**
 * @description curry 函数柯里化
 * @param func 函数
 * @return 函数
 */</span>
<span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> outerargs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> innerargs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outerargs <span class="token operator">=</span> outerargs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>innerargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> inner<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  inner<span class="token punctuation">.</span>toString <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>outerargs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> inner<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="反柯里化"><a href="#反柯里化" class="headerlink" title="反柯里化"></a>反柯里化</h3>
      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2019-2020
        Walter
      </li>
      <li>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
      </li>
      
      <li>
        <a href="http://www.beian.miit.gov.cn/" target="_black">豫ICP备17047806号</a>
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/logo.png" alt="Walter"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i></p>
  <div class="reward-box">
    
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>





<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>





<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>


    
  </div>
</body>

</html>